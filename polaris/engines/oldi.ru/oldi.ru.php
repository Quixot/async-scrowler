<?php
/**
 * oldi.ru
 * 
 */
$domain = '';
switch (EXTRA_PARAM) {
case 'abakan': $region = '259896'; break; // Абакан
case 'almetevsk': $region = '259940'; break; // Альметьевск
case 'anapa': $region = '260048'; break; // Анапа
case 'angarsk': $region = '259908'; break; // Ангарск
case 'apatity': $region = '267139'; break; // Апатиты
case 'arzamas': $region = '265940'; break; // Арзамас
case 'armavir': $region = '259968'; break; // Армавир
case 'arhangelsk': $region = '259773'; break; // Архангельск
case 'astrakhan': $region = '259893'; break; // Астрахань
case 'achinsk': $region = '263820'; break; // Ачинск
case 'balakovo': $region = '266421'; break; // Балаково
case 'barnaul': $region = '259917'; break; // Барнаул
case 'belgorod': $region = '259830'; break; // Белгород
case 'berezniki': $region = '259965'; break; // Березники
case 'biysk': $region = '260032'; break; // Бийск
case 'blagoveschensk': $region = '259875'; break; // Благовещенск
case 'borisoglebsk': $region = '259934'; break; // Борисоглебск
case 'bratsk': $region = '259916'; break; // Братск
case 'bryansk': $region = '259811'; break; // Брянск
case 'velikijnovgorod': $region = '267227'; break; // Великий Новгород
case 'vladivostok': $region = '259958'; break; // Владивосток
case 'vladikavkaz': $region = '259846'; break; // Владикавказ
case 'vladimir': $region = '259824'; break; // Владимир
case 'volgograd': $region = '259802'; break; // Волгоград
case 'volgodonsk': $region = '259912'; break; // Волгодонск
case 'volzhskij': $region = '826038'; break; // Волжский
case 'vologda': $region = '259828'; break; // Вологда
case 'voronezh': $region = '259780'; break; // Воронеж
case 'gubkin': $region = '264404'; break; // Губкин
case 'dimitrovgrad': $region = '259981'; break; // Димитровград
case 'yekaterinburg': $region = '259907'; $domain = 'ekb.'; break; // Екатеринбург
case 'essentuki': $region = '260015'; break; // Ессентуки
case 'zheleznogorsk': $region = '259975'; break; // Железногорск
case 'ivanovo': $region = '259799'; break; // Иваново
case 'izhevsk': $region = '259786'; break; // Ижевск
case 'irkutsk': $region = '259876'; break; // Иркутск
case 'joshkar-ola': $region = '259848'; break; // Йошкар-Ола
case 'kazan': $region = '259789'; break; // Казань
case 'kaliningrad': $region = '259801'; break; // Калининград
case 'kaluga': $region = '259796'; break; // Калуга
case 'kamyshin': $region = '259924'; break; // Камышин
case 'kasimov': $region = '259925'; break; // Касимов
case 'kemerovo': $region = '264941'; break; // Кемерово
case 'kirov': $region = '259808'; break; // Киров
case 'kislovodsk': $region = '260039'; break; // Кисловодск
case 'kostroma': $region = '259816'; break; // Кострома
case 'krasnodar': $region = '259792'; break; // Краснодар
case 'krasnoturinsk': $region = '260087'; break; // Краснотурьинск
case 'krasnoyarsk': $region = '259895'; break; // Красноярск
case 'kropotkin': $region = '263806'; break; // Кропоткин
case 'kurgan': $region = '267195'; break; // Курган
case 'kursk': $region = '259923'; break; // Курск
case 'lipeck': $region = '259835'; break; // Липецк
case 'lyantor': $region = '267111'; break; // Лянтор
case 'magnitogorsk': $region = '259827'; break; // Магнитогорск
case 'majkop': $region = '267219'; break; // Майкоп
case 'mahachkala': $region = '259969'; break; // Махачкала
case 'miass': $region = '260042'; break; // Миасс
case 'mineralnye-vody': $region = '264337'; break; // Минеральные Воды
case 'moscow': $region = '259749'; break; // Москва
case 'murmansk': $region = '259998'; break; // Мурманск
case 'naberezhnye-chelny': $region = '259'; break; // Набережные Челны
case 'nadym': $region = '259821'; break; // Надым
case 'nalchik': $region = '259989'; break; // Нальчик
case 'nevinnomyssk': $region = '267214'; break; // Невинномысск
case 'neftekamsk': $region = '260115'; break; // Нефтекамск
case 'nefteyugansk': $region = '259785'; break; // Нефтеюганск
case 'nizhnevartovsk': $region = '259790'; break; // Нижневартовск
case 'nizhnekamsk': $region = '259855'; break; // Нижнекамск
case 'novgorod': $region = '259858'; $domain = 'nnov.'; break; // Нижний Новгород
case 'nizhnij-tagil': $region = '260060'; break; // Нижний Тагил
case 'novokuzneck': $region = '264951'; break; // Новокузнецк
case 'novorossijsk': $region = '259983'; break; // Новороссийск
case 'novosibirsk': $region = '259900'; $domain = 'nsk.'; break; // Новосибирск
case 'novotroick': $region = '260100'; break; // Новотроицк
case 'novocherkassk': $region = '267202'; break; // Новочеркасск
case 'novyj-urengoj': $region = '259775'; break; // Новый Уренгой
case 'noyabrsk': $region = '259825'; break; // Ноябрьск
case 'nyagan': $region = '260009'; break; // Нягань
case 'obninsk': $region = '259814'; break; // Обнинск
case 'oktyabrskij': $region = '262126'; break; // Октябрьский
case 'omsk': $region = '259797'; break; // Омск
case 'orenburg': $region = '259913'; break; // Оренбург
case 'pavlovo': $region = '265970'; break; // Павлово
case 'penza': $region = '259833'; break; // Пенза
case 'pervouralsk': $region = '260062'; break; // Первоуральск
case 'perm': $region = '259864'; break; // Пермь
case 'petrozavodsk': $region = '259888'; break; // Петрозаводск
case 'pskov': $region = '260019'; break; // Псков
case 'pyatigorsk': $region = '259901'; break; // Пятигорск
case 'revda': $region = '260064'; break; // Ревда
case 'rostov': $region = '259834'; $domain = 'rnd.'; break; // Ростов-на-Дону
case 'rybinsk': $region = '259966'; break; // Рыбинск
case 'ryazan': $region = '259819'; break; // Рязань
case 'salavat': $region = '260072'; break; // Салават
case 'samara': $region = '259788'; break; // Самара
case 'spb': $region = '269480'; $domain = 'spb.'; break; // Санкт-Петербург
case 'saransk': $region = '259911'; break; // Саранск
case 'saratov': $region = '259897'; break; // Саратов
case 'sarov': $region = '259964'; break; // Саров
case 'severodvinsk': $region = '259904'; break; // Северодвинск
case 'seversk': $region = '259754'; break; // Северск
case 'smolensk': $region = '259898'; break; // Смоленск
case 'solnechnogorsk': $region = '259807'; break; // Солнечногорск
case 'sochi': $region = '259891'; break; // Сочи
case 'stavropol': $region = '259959'; break; // Ставрополь
case 'staryj-oskol': $region = '259800'; break; // Старый Оскол
case 'sterlitamak': $region = '262759'; break; // Стерлитамак
case 'stupino': $region = '259953'; break; // Ступино
case 'surgut': $region = '259779'; break; // Сургут
case 'syzran': $region = '260071'; break; // Сызрань
case 'syktyvkar': $region = '259926'; break; // Сыктывкар
case 'taganrog': $region = '260037'; break; // Таганрог
case 'tambov': $region = '266879'; break; // Тамбов
case 'tver': $region = '259823'; break; // Тверь
case 'tobolsk': $region = '260108'; break; // Тобольск
case 'tolyatti': $region = '259877'; break; // Тольятти
case 'tomsk': $region = '260011'; break; // Томск
case 'tula': $region = '259809'; break; // Тула
case 'tyumen': $region = '259838'; break; // Тюмень
case 'ulan-udeh': $region = '259915'; break; // Улан-Удэ
case 'ulyanovsk': $region = '259804'; break; // Ульяновск
case 'ufa': $region = '259771'; break; // Уфа
case 'uhta': $region = '259879'; break; // Ухта
case 'habarovsk': $region = '259777'; break; // Хабаровск
case 'hanty-mansijsk': $region = '259861'; break; // Ханты-Мансийск
case 'cheboksary': $region = '259782'; break; // Чебоксары
case 'chelyabinsk': $region = '259890'; break; // Челябинск
case 'cherepovec': $region = '259892'; break; // Череповец
case 'cherkessk': $region = '260043'; break; // Черкесск
case 'chita': $region = '259987'; break; // Чита
case 'shahty': $region = '267156'; break; // Шахты
case 'ehngels': $region = '260049'; break; // Энгельс
case 'yugorsk': $region = '259994'; break; // Югорск
case 'yakutsk': $region = '259872'; break; // Якутск
case 'yaroslavl': $region = '259863'; break; // Ярославль
 	default:
 		die("Unknown region\n");  		
}

if ($domain) {
	$urlStart = 'https://'.$domain.'oldi.ru/search/?q='.ENGINE_TYPE;
} else {
	$urlStart = 'https://www.oldi.ru/search/?q='.ENGINE_TYPE;
}

$regexp1 	= "~class='cnt'>(.+)<.*<a.*href=\"(.+)\"~isU";
//$regexpP1	= "~class='numbs'>(.+)</div~isU";
//$regexpP2 = "~<a.*>(.+)<~isU";
$regexpC1 = "~data-vid=\"(.+)catalog-list-options~isU";
$regexpC2 = "~class=\"catalog-list-info.*<a.*href=\"(.+)\".*>.*>(.+)<.*class=\"catalog-list-price\">(.+)<~isU";
$regexpC3 = "~class=\"catalog-list-info.*<a.*href=\"(.+)\".*>.*>(.+)<~isU";

//http://www.'.$domain.'oldi.ru/search/?selectCityID=265940&q=rondell
	// Узнаем, сколько позиций в пагинации
if ($domain) {
	$AC->get($urlStart);
	$AC->get($urlStart);
	$AC->get($urlStart);
} else {
	$AC->get($urlStart.'&selectCityID='.$region, null, array(CURLOPT_COOKIEJAR 	=> __DIR__.'/cook/'.time().'.cook', CURLOPT_COOKIEFILE	=> __DIR__.'/cook/'.time().'.cook'));
	$AC->get($urlStart.'&selectCityID='.$region, null, array(CURLOPT_COOKIEJAR 	=> __DIR__.'/cook/'.time().'.cook', CURLOPT_COOKIEFILE	=> __DIR__.'/cook/'.time().'.cook'));
	$AC->get($urlStart.'&selectCityID='.$region, null, array(CURLOPT_COOKIEJAR 	=> __DIR__.'/cook/'.time().'.cook', CURLOPT_COOKIEFILE	=> __DIR__.'/cook/'.time().'.cook'));
}
	$AC->execute(3);

	if (!count($linkarray)) die("can't find any link\n");

	// Наименования товара и цены
	$AC->flush_requests();
	$AC->__set('callback','callback_two');	

	if ($domain) {
		for ($i = 0; $i < count($linkarray); $i++) {
			$temp = preg_replace('~[^\d.]+~', '' , $linkqount[$i]);
			if ($temp <= 100) {
				$AC->get('https://'.$domain.'oldi.ru' . $linkarray[$i] . ENGINE_TYPE . '/?perpage=100');
			} else {
				for ($q = 1; $q <= ceil($temp/100); $q++) {
					$AC->get('https://'.$domain.'oldi.ru' . $linkarray[$i] . ENGINE_TYPE . '/?perpage=100&PAGEN_1=' . $q);
				}			
			}	
		}
	} else {
		for ($i = 0; $i < count($linkarray); $i++) {
			$temp = preg_replace('~[^\d.]+~', '' , $linkqount[$i]);
			if ($temp <= 100) {
				$AC->get('https://www.oldi.ru' . $linkarray[$i] . ENGINE_TYPE . '/?perpage=100'.'&selectCityID='.$region, null, array(CURLOPT_COOKIEJAR 	=> __DIR__.'/cook/'.time().'.cook', CURLOPT_COOKIEFILE	=> __DIR__.'/cook/'.time().'.cook'));
			} else {
				for ($q = 1; $q <= ceil($temp/100); $q++) {
					$AC->get('https://www.oldi.ru' . $linkarray[$i] . ENGINE_TYPE . '/?perpage=100&PAGEN_1=' . $q.'&selectCityID='.$region, null, array(CURLOPT_COOKIEJAR 	=> __DIR__.'/cook/'.time().'.cook', CURLOPT_COOKIEFILE	=> __DIR__.'/cook/'.time().'.cook'));
				}			
			}	
		}	
	}
	$AC->execute(WINDOW_SIZE);

	while ($bad_urls) {      // Перебираем заново адреса, не вернувшие контент
	  $AC->flush_requests(); // Чистим массив запросов
	  foreach ($bad_urls as $urls) { // Готовим новый цикл из битых URLs
	    $AC->get($urls, null, array(CURLOPT_COOKIEJAR 	=> __DIR__.'/cook/'.time().'.cook', CURLOPT_COOKIEFILE	=> __DIR__.'/cook/'.time().'.cook'));      
	  }
	  unset($urls);

	  $bad_urls = array();    // Чистим массив URL-ов для следующего (возможного) цикла    
	  $AC->execute(WINDOW_SIZE);       // Запускаем цикл, пока последний адрес не вернёт контент. Нужно придумать условия выхода!!!!!
	}
	unset($urls);



/** 
 *              Callback Functions           
 */
function callback_one($response, $info, $request) {
  global $regexp1;
  global $linkarray;
  global $linkqount;
	global $regexpC1;
	global $regexpC2;
	global $regexpC3;
	global $itemsArray;  
  global $bad_urls;
  global $domain;

 	AngryCurl::add_debug_msg(PHP_EOL.$request->url);
	AngryCurl::add_debug_msg($info['http_code']);
	AngryCurl::add_debug_msg($request->options[10004]); 

  if ($info['http_code'] !== 200) {            
    //if (strripos($info['url'], ENGINE_CURR) !== false) {
    	//////echo"CODE: " . $info['http_code'] . "\n";
      //$bad_urls[] = $info['url'];
    //}
  } else {
		preg_match_all($regexp1, $response, $matches);
		if (!count($linkarray)) {
			$linkqount = $matches[1];   				
			$linkarray = $matches[2];			
			//print_r($linkqount);
			print_r($linkarray);
		}

  	preg_match_all("~class=\"smallparams\"(.+)class=\"pcomm\"~isU", $response, $matches, PREG_SET_ORDER); //
  	//print_r($matches);
  	preg_match("~id=\"head_geo_select\".*>.*>(.+)<~isU", $response, $showregion);
  	AngryCurl::add_debug_msg(iconv('windows-1251', 'utf-8', $showregion[1]));
  	foreach ($matches as $key) {
			preg_match("~class='h3'.*href=\"(.+)\".*>(.+)<.*class=\"price price_fix\">(.+)<~isU", $key[1], $matches2);
			//print_r($matches2);
			if ($matches2[3]) {
				price_change_detect('http://www.'.$domain.'oldi.ru' . trim($matches2[1]), trim(iconv('windows-1251', 'utf-8', $matches2[2])), preg_replace('~[\D]+~', '' , $matches2[3]), date("d.m.y-H:i:s"), $request->options[10004], $request->options[10006], $request->options[10018], ENGINE_CURR, ENGINE_TYPE);		
				$itemsArray['http://www.'.$domain.'oldi.ru' . trim($matches2[1])] = array(trim(iconv('windows-1251', 'utf-8', $matches2[2])), preg_replace('~[\D]+~', '' , $matches2[3]), date("d.m.y-H:i:s"), $request->options[10004]);		
				AngryCurl::add_debug_msg(trim(iconv('windows-1251', 'utf-8', $matches2[2])).' | '.preg_replace('~[\D]+~', '' , $matches2[3]));
			} else {
				preg_match($regexpC3, $key[1], $matches2);
				if ($matches2[1]) {
					price_change_detect('http://www.'.$domain.'oldi.ru' . trim($matches2[1]), trim(iconv('windows-1251', 'utf-8', $matches2[2])), '0', date("d.m.y-H:i:s"), $request->options[10004], $request->options[10006], $request->options[10018], ENGINE_CURR, ENGINE_TYPE);
					$itemsArray['http://www.'.$domain.'oldi.ru' . trim($matches2[1])] = array(trim(iconv('windows-1251', 'utf-8', $matches2[2])), '0', date("d.m.y-H:i:s"), $request->options[10004]);		
					AngryCurl::add_debug_msg(trim(iconv('windows-1251', 'utf-8', $matches2[2])).' | 0');
				}
			}
		}

  }
}

function callback_two($response, $info, $request) {
	global $regexpC1;
	global $regexpC2;
	global $regexpC3;
	global $itemsArray;
	global $bad_urls;
	global $time_start;
	global $domain;

	//preg_match("~/catalog/(.+)/~isU", $request->url, $name);
	//file_put_contents('/var/www/engines/oldi.ru/temp/'.$name[1], $response);

	AngryCurl::add_debug_msg(PHP_EOL.$request->url);
	AngryCurl::add_debug_msg($info['http_code']);
	AngryCurl::add_debug_msg($request->options[10004]);	

  if ($info['http_code'] !== 200) {
		$bad_urls[] = $request->url;
  	/**
  	 * Выходим, если прошло слишком много времени
  	 */  	
		if (round(microtime(1) - $time_start, 0) >= 340) { $bad_urls = array(); }        
  } else {	
  	preg_match_all($regexpC1, $response, $matches, PREG_SET_ORDER); //
  	//print_r($matches);
  	preg_match("~id=\"head_geo_select\".*>.*>(.+)<~isU", $response, $showregion);
  	AngryCurl::add_debug_msg(iconv('windows-1251', 'utf-8', $showregion[1]));
  	foreach ($matches as $key) {
			preg_match($regexpC2, $key[1], $matches2);
			//print_r($matches2);
			if ($matches2[3]) {
				price_change_detect('http://www.'.$domain.'oldi.ru' . trim($matches2[1]), trim(iconv('windows-1251', 'utf-8', $matches2[2])), preg_replace('~[\D]+~', '' , $matches2[3]), date("d.m.y-H:i:s"), $request->options[10004], $request->options[10006], $request->options[10018], ENGINE_CURR, ENGINE_TYPE);		
				$itemsArray['http://www.'.$domain.'oldi.ru' . trim($matches2[1])] = array(trim(iconv('windows-1251', 'utf-8', $matches2[2])), preg_replace('~[\D]+~', '' , $matches2[3]), date("d.m.y-H:i:s"), $request->options[10004]);		
				AngryCurl::add_debug_msg(trim(iconv('windows-1251', 'utf-8', $matches2[2])).' | '.preg_replace('~[\D]+~', '' , $matches2[3]));
			} else {
				preg_match($regexpC3, $key[1], $matches2);
				if ($matches2[1]) {
					price_change_detect('http://www.'.$domain.'oldi.ru' . trim($matches2[1]), trim(iconv('windows-1251', 'utf-8', $matches2[2])), '0', date("d.m.y-H:i:s"), $request->options[10004], $request->options[10006], $request->options[10018], ENGINE_CURR, ENGINE_TYPE);
					$itemsArray['http://www.'.$domain.'oldi.ru' . trim($matches2[1])] = array(trim(iconv('windows-1251', 'utf-8', $matches2[2])), '0', date("d.m.y-H:i:s"), $request->options[10004]);		
					AngryCurl::add_debug_msg(trim(iconv('windows-1251', 'utf-8', $matches2[2])).' | 0');
				}
			}
		} 	
  }
}
