<?php
/**
 * mvideo.ru Москва Новосибирск
 */
defined('_JEXEC') or die('Silentium videtur confessio');

switch (EXTRA_PARAM) {
  case 'abakan': 
  	$region = 'CityDE_28838';
    break;
  case 'almetevsk': 
  	$region = 'CityR_32';
    break;
  case 'anapa': 
  	$region = 'CityR_119';
    break;
  case 'angarsk': 
  	$region = 'CityR_145';
    break;
  case 'apatity': 
  	$region = 'CityR_190';
    break;
  case 'arzamas': 
  	$region = 'CityR_103';
    break; 
  case 'armavir': 
  	$region = 'CityR_73';
    break; 
  case 'arhangelsk': 
  	$region = 'CityCZ_9915';
    break;
  case 'astrakhan': 
  	$region = 'CityCZ_6261';
    break;
  case 'achinsk': 
  	$region = 'CityR_195';
    break;
  case 'balakovo': 
  	$region = 'CityR_91';
    break;
  case 'barnaul': 
  	$region = 'CityCZ_9912';
    break;
  case 'belgorod': 
  	$region = 'CityCZ_15507';
    break;
  case 'berezniki': 
  	$region = 'CityDE_31042';
    break;
  case 'biysk': 
  	$region = 'CityR_90';
    break;
  case 'borisoglebsk': 
  	$region = 'CityR_192';
    break;
  case 'bratsk': 
  	$region = 'CityR_115';
    break;
  case 'bryansk': 
  	$region = 'CityCZ_15535';
    break;
  case 'velikijnovgorod': 
  	$region = 'CityDE_30978';
    break;
  case 'vladikavkaz': 
  	$region = 'CityR_62';
    break;
  case 'vladimir': 
  	$region = 'CityCZ_6899';
    break;
  case 'volgodonsk': 
  	$region = 'CityR_54';
    break;
  case 'volzhskij': 
  	$region = 'CityCZ_3062';
    break;
  case 'vologda': 
  	$region = 'CityCZ_15577';
    break;
  case 'gubkin': 
  	$region = 'CityR_64';
    break;
  case 'derbent': 
  	$region = 'CityR_121';
    break;
  case 'dimitrovgrad': 
  	$region = 'CityR_116';
    break;
  case 'essentuki': 
  	$region = 'CityR_111';
    break;
  case 'zheleznogorsk': 
  	$region = 'CityR_69';
    break;
  case 'ivanovo': 
  	$region = 'CityCZ_15528';
    break;
  case 'izhevsk': 
  	$region = 'CityCZ_6273';
    break;
  case 'irkutsk': 
  	$region = 'CityCZ_11818';
    break;
  case 'joshkar-ola': 
  	$region = 'CityR_72';
    break;
  case 'kaluga': 
  	$region = 'CityR_106';
    break;
  case 'kamyshin': 
  	$region = 'CityR_151';
    break;
  case 'kasimov': 
  	$region = 'CityDE_31274';
    break;
  case 'kemerovo': 
  	$region = 'CityCZ_9918';
    break;
  case 'kirov': 
  	$region = 'CityCZ_15556';
    break;
  case 'kislovodsk': 
  	$region = 'CityR_87';
    break;
  case 'kostroma': 
  	$region = 'CityR_44';
    break;
  case 'krasnoturinsk': 
  	$region = 'CityR_147';
    break;
  case 'kropotkin': 
  	$region = 'CityR_125';
    break;    
  case 'kurgan': 
  	$region = 'CityR_50';
    break;
  case 'kursk': 
  	$region = 'CityCZ_7194';
    break;
  case 'lipeck': 
  	$region = 'CityCZ_15500';
    break;
  case 'lyantor': 
  	$region = 'CityR_110';
    break;
  case 'magnitogorsk': 
  	$region = 'CityR_27';
    break;
  case 'majkop': 
  	$region = 'CityR_114';
    break;
  case 'mahachkala': 
  	$region = 'CityR_74';
    break;
  case 'miass': 
  	$region = 'CityR_172';
    break;
  case 'mineralnye-vody': 
  	$region = 'CityR_143';
    break;
  case 'murmansk': 
  	$region = 'CityR_144';
    break;
  case 'naberezhnye-chelny': 
  	$region = 'CityCZ_15563';
    break;
  case 'nadym': 
  	$region = 'CityDE_28766';
    break;
  case 'nalchik': 
  	$region = 'CityR_38';
    break;
  case 'nevinnomyssk': 
  	$region = 'CityR_123';
    break;
  case 'neftekamsk': 
  	$region = 'CityR_96';
    break;
  case 'nefteyugansk': 
  	$region = 'CityR_61';
    break;
  case 'nizhnevartovsk': 
  	$region = 'CityCZ_9969';
    break;
  case 'nizhnekamsk': 
  	$region = 'CityR_46';
    break;
  case 'nizhnij-tagil': 
  	$region = 'CityR_56';
    break;
  case 'novokuzneck': 
  	$region = 'CityCZ_15584';
    break;
  case 'novorossijsk': 
  	$region = 'CityCZ_6264';
    break;
  case 'novotroick': 
  	$region = 'CityR_70';
    break;
  case 'novocherkassk': 
  	$region = 'CityR_191';
    break;
  case 'novyj-urengoj': 
  	$region = 'CityR_85';
    break;
  case 'noyabrsk': 
  	$region = 'CityR_92';
    break;
  case 'nyagan': 
  	$region = 'CityR_79';
    break;
  case 'obninsk': 
  	$region = 'CityR_82';
    break;
  case 'oktyabrskij': 
  	$region = 'CityCZ_15514';
    break;
  case 'orel': 
  	$region = 'CityCZ_15542';
    break;
  case 'orenburg': 
  	$region = 'CityCZ_6276';
    break;
  case 'orsk': 
  	$region = 'CityCZ_15549';
    break;
  case 'pavlovo': 
  	$region = '7300330';
    break;
  case 'penza': 
  	$region = 'CityCZ_7182';
    break;
  case 'pervouralsk': 
  	$region = 'CityR_93';
    break;
  case 'petrozavodsk': 
  	$region = 'CityR_122';
    break;
  case 'pskov': 
  	$region = 'CityR_49';
    break;
  case 'pyatigorsk': 
  	$region = 'CityR_76';
    break;
  case 'revda': 
  	$region = 'CityR_149';
    break;
  case 'rybinsk': 
  	$region = 'CityR_127';
    break;
  case 'ryazan': 
  	$region = 'CityCZ_7179';
    break;
  case 'salavat': 
  	$region = 'CityR_58';
    break;
  case 'saransk': 
  	$region = 'CityR_95';
    break;
  case 'saratov': 
  	$region = 'CityCZ_984';
    break;
  case 'sarov': 
  	$region = 'CityR_126';
    break;
  case 'severodvinsk': 
  	$region = 'CityR_120';
    break;
  case 'seversk': 
  	$region = 'CityCZ_13165';
    break;
  case 'smolensk': 
  	$region = 'CityR_124';
    break;
  case 'solnechnogorsk': 
  	$region = 'CityCZ_35772';
    break;
  case 'sochi': 
  	$region = 'CityCZ_6267';
    break;
  case 'stavropol': 
  	$region = 'CityCZ_1370';
    break;
  case 'staryj-oskol': 
  	$region = 'CityR_47';
    break;
  case 'sterlitamak': 
  	$region = 'CityR_60';
    break;
  case 'stupino': 
  	$region = 'CityDE_30890';
    break;
  case 'surgut': 
  	$region = 'CityCZ_9963';
    break;
  case 'syzran': 
  	$region = 'CityR_109';
    break;
  case 'syktyvkar': 
  	$region = 'CityR_102';
    break;
  case 'taganrog': 
  	$region = 'CityR_41';
    break;
  case 'tambov': 
  	$region = 'CityCZ_15598';
    break;
  case 'tver': 
  	$region = 'CityR_88';
    break;
  case 'tobolsk': 
  	$region = 'CityR_105';
    break;
  case 'tolyatti': 
  	$region = 'CityCZ_6270';
    break;
  case 'tomsk': 
  	$region = 'CityCZ_9966';
    break;
  case 'tuapse': 
  	$region = 'CityR_94';
    break;
  case 'tula': 
  	$region = 'CityCZ_15521';
    break;
  case 'tyumen': 
  	$region = 'CityCZ_1024';
    break;
  case 'ulan-udeh': 
  	$region = 'CityR_98';
    break;
  case 'ulyanovsk': 
  	$region = 'CityCZ_15570';
    break;
  case 'uhta': 
  	$region = 'CityR_101';
    break;
  case 'habarovsk': 
  	$region = 'CityDE_28834';
    break;
  case 'hanty-mansijsk': 
  	$region = 'CityR_34';
    break;
  case 'cheboksary': 
  	$region = 'CityR_67';
    break;
  case 'cherepovec': 
  	$region = 'CityCZ_15591';
    break;
  case 'cherkessk': 
  	$region = 'CityR_108';
    break;
  case 'chita': 
  	$region = 'CityDE_28882';
    break;
  case 'shahty': 
  	$region = 'CityR_189';
    break;
  case 'ehngels': 
  	$region = 'CityCZ_2714';
    break;
  case 'yugorsk': 
  	$region = 'CityDE_29162';
    break;
  case 'yaroslavl': 
  	$region = 'CityCZ_7176';
    break;

// Города - Миллионики
  case 'moscow': 
  	$region = 'CityCZ_975';
    break;
  case 'spb':
    $region = 'CityCZ_1638';
    break;    
 	case 'blagoveschensk':
 		$region = 'CityDE_28702';
 		break;
  case 'rostov':
  	$region = 'CityCZ_2446';
    break;    
  case 'novosibirsk':
  	$region = 'CityCZ_2246';
  	break;
 	case 'yekaterinburg':
 		$region = 'CityCZ_2030';  	
 		break;
 	case 'chelyabinsk':
 		$region = 'CityCZ_1216';
 		break;
 	case 'volgograd':
 		$region = 'CityCZ_1272';
 		break; 	
 	case 'perm':
 		$region = 'CityCZ_1250';
 		break;
 	case 'kazan':
 		$region = 'CityCZ_1458';
 		break;
 	case 'novgorod':
 		$region = 'CityCZ_974';
 		break; 		
 	case 'omsk':
 		$region = 'CityCZ_9909';
 		break;
 	case 'samara':
 		$region = 'CityCZ_1780';
 		break;
 	case 'ufa':
 		$region = 'CityCZ_2534';
 		break;
 	case 'kaliningrad':
 		$region = 'CityR_146';
 		break;
 	case 'krasnoyarsk':
 		$region = 'CityCZ_1854';
 		break;
 	case 'krasnodar':
 		$region = 'CityCZ_2128';
 		break;
 	case 'voronezh':
 		$region = 'CityCZ_7173';
 		break;
 	case 'vladivostok':
 		$region = 'CityDE_31146';
 		break;
 	case 'yakutsk':
 		$region = 'CityR_104';
 		break;
 	default:
 		die("Unknown region\n");    	
}


$options 			= array(CURLOPT_COOKIE => 'MVID_CITY_ID=' . $region); 	// Подставляем coockie региона
$urlStart 		= 'http://www.mvideo.ru/product-list?Dy=1&No=';							// Первая часть адреса
$urlEnd				= '&Nrpp=24&Nty=1&Ntt=' . ENGINE_TYPE;							 				// Вторая часть адреа и поисковая строка
$regexpPagin	= "~class=\"search-results-heading-qty\">(.+)</span>~isU"; 	// К-во найденых товаров
$regexpPrices = "~class=\"product-tile-picture\"(.+)<div class=\"product-tile-gift-card\">~isU"; // Все товары на странице
$regexpPrices2 = "~class=\"product-tile-description\".*<a href=\"(.+)\".*>(.+)<.*class=\"product-price-current.*>(.+)<~isU";
$regexpPrices3 = "~class=\"product-tile-description\".*<a href=\"(.+)\".*>(.+)<~isU"; // Режем карточки товара

$tasks = '/var/www/tasks/'.ENGINE_CURR.'_'.ENGINE_TYPE.'_'.EXTRA_PARAM.'.txt';
if (file_exists($tasks) && time() - filemtime($tasks) < 3600) {
	echo 'THIS IS BAD URLS FROM FILE'.PHP_EOL;
	$bad_urls = unserialize(file_get_contents($tasks));
	$bad_urls = array_unique($bad_urls);
	while ($bad_urls) {      // Перебираем заново адреса, не вернувшие контент
		if (round(microtime(1) - $time_start, 0) <= 280) {
			break;
		}
	  $AC->flush_requests(); // Чистим массив запросов
	  foreach ($bad_urls as $urls) { // Готовим новый цикл из битых URLs
	    $AC->get($urls, NULL, $options);
	    $AC->add_debug_msg("Bad URLs: $urls"); // LOG ⇒ Можем посмотреть сколько адресов при первом прогоне вернули пустоту        
	  }
	  $bad_urls = array();    // Чистим массив URL-ов для следующего (возможного) цикла    
	  $AC->execute(WINDOW_SIZE);       // Запускаем цикл, пока последний адрес не вернёт контент. Нужно придумать условия выхода!!!!!
	}
	$bad_urls = array_unique($bad_urls);
	file_put_contents($tasks, serialize($bad_urls));		
} else {
	// Узнаем, сколько позиций в пагинации
	$AC->get('http://www.mvideo.ru/product-list?Nty=1&Dy=1&Nrpp=0&Ntt=' . ENGINE_TYPE, NULL, $options);
	$AC->get('http://www.mvideo.ru/product-list?Nty=1&Dy=1&Nrpp=48&Ntt=' . ENGINE_TYPE, NULL, $options);	
	$AC->get('http://www.mvideo.ru/product-list?Nty=1&Dy=1&Nrpp=24&Ntt=' . ENGINE_TYPE, NULL, $options);	
	$AC->get('http://www.mvideo.ru/product-list?Nty=1&Dy=1&Nrpp=72&Ntt=' . ENGINE_TYPE, NULL, $options);	
	$AC->get('http://www.mvideo.ru/product-list?Nty=1&Dy=1&Nrpp=96&Ntt=' . ENGINE_TYPE, NULL, $options);
	//echo 'http://www.mvideo.ru/product-list?Nty=1&Dy=1&Nrpp=24&Ntt=' . ENGINE_TYPE;
	$AC->execute(5);


	// Наименования товара и цены
	$AC->flush_requests();
	$AC->__set('callback','callback_two');	

	//echo 'Количество страниц: ' . $qOfPaginationPages . "\n";

	if ($qOfPaginationPages > 1) {
		for ($i = 1; $i < $qOfPaginationPages; $i++) {
		  $AC->get($urlStart . $i * 12 . $urlEnd, NULL, $options);
		  $AC->add_debug_msg( $urlStart . $i * 12 . $urlEnd ); // Проверим, какие адреса записываются для выполнения    
		}
		$AC->execute(WINDOW_SIZE);

		if (round(microtime(1) - $time_start, 0) <= 280) {
			$bad_urls = array_unique($bad_urls);
			while ($bad_urls) {      // Перебираем заново адреса, не вернувшие контент
			  $AC->flush_requests(); // Чистим массив запросов
			  foreach ($bad_urls as $urls) { // Готовим новый цикл из битых URLs
			    $AC->get($urls, NULL, $options);
			    $AC->add_debug_msg("Bad URLs: $urls"); // LOG ⇒ Можем посмотреть сколько адресов при первом прогоне вернули пустоту        
			  }
			  $bad_urls = array();    // Чистим массив URL-ов для следующего (возможного) цикла    
			  $AC->execute(WINDOW_SIZE);       // Запускаем цикл, пока последний адрес не вернёт контент. Нужно придумать условия выхода!!!!!
			}
		} else {
			$bad_urls = array_unique($bad_urls);
			file_put_contents($tasks, serialize($bad_urls));
		}
	}
} // BAD_URLS

$bad_urls = array_unique($bad_urls);
file_put_contents($tasks, serialize($bad_urls));

/** 
 *              Callback Functions           
 */
function callback_one($response, $info, $request) {
  global $regexpPagin;
	global $regexpP;
  global $regexpP2;
  global $qOfPaginationPages;
  global $bad_urls;
  global $region;
	global $regexpPrices;
	global $regexpPrices2;
	global $regexpPrices3;
	global $itemsArray;
	global $subdomen; // Субдомен
	global $time_start;

  echo $info['http_code']."\n";
  echo $info['url']."\n";

  if ($info['http_code'] !== 200) {            
    if (stripos($info['url'], ENGINE_CURR)) {
      $bad_urls[] = $info['url'];
    }
  } else {
	  preg_match($regexpPagin, $response, $matches); // Сколько страниц цен	  
	  //print_r($matches);
	  $temp = ceil( preg_replace('~[^\d]+~', '' , $matches[1]) / 12 );
	  if ($temp > $qOfPaginationPages) {      
		  $qOfPaginationPages = $temp;
	  } 

		  preg_match_all($regexpPrices, $response, $matches2, PREG_SET_ORDER); //
		  foreach ($matches2 as $key) {
				preg_match($regexpPrices2, $key[1], $matches);
				if (@$matches[1]) {
					if (strripos($key[1], 'submit-basket') !== false) {
						price_change_detect('http://' . ENGINE_CURR . trim($matches[1]), trim($matches[2]), trim($matches[3]), date("d.m.y-H:i:s"), $request->options[10004], $request->options[10006], $request->options[10018], ENGINE_CURR, ENGINE_TYPE);
						$itemsArray['http://' . ENGINE_CURR . trim($matches[1])] = array(trim($matches[2]), trim($matches[3]), date("d.m.y-H:i:s"), $request->options[10004]);		
						echo trim($matches[1]) . "\n";
					} else {
						price_change_detect('http://' . ENGINE_CURR . trim($matches[1]), trim($matches[2]), '0', date("d.m.y-H:i:s"), $request->options[10004], $request->options[10006], $request->options[10018], ENGINE_CURR, ENGINE_TYPE);
						$itemsArray['http://' . ENGINE_CURR . trim($matches[1])] = array(trim($matches[2]), '0', date("d.m.y-H:i:s"), $request->options[10004]);		
						echo trim($matches[1]) . " - null\n";						
					}
				} else {
					preg_match($regexpPrices3, $key[1], $matches);
					if (@$matches[1]) {
						price_change_detect('http://' . ENGINE_CURR . trim($matches[1]), trim($matches[2]), '0', date("d.m.y-H:i:s"), $request->options[10004], $request->options[10006], $request->options[10018], ENGINE_CURR, ENGINE_TYPE);
						$itemsArray['http://' . ENGINE_CURR . trim($matches[1])] = array(trim($matches[2]), '0', date("d.m.y-H:i:s"), $request->options[10004]);		
						echo trim($matches[1]) . " - null\n";	
					}
				}
			}

  }
}

function callback_two($response, $info, $request) {
	global $regexpPrices;
	global $regexpPrices2;
	global $regexpPrices3;
	global $matches;
	global $itemsArray;
	global $bad_urls;
	global $subdomen; // Субдомен
	global $time_start;
	global $region;

  echo $info['http_code']."\n";
  echo $info['url']."\n";

  if ($info['http_code'] !== 200) {
    if (stripos($info['url'], ENGINE_CURR)/* && strripos($info['url'], 'old-browsers-holding-page') === false*/) {
      $bad_urls[] = $info['url'];
    }      
  } else {
    if (stripos($info['url'], ENGINE_CURR) !== false && $response && strripos($response, '</html') === false) {       
      $bad_urls[] = $info['url'];    
    } else { 	
		  preg_match_all($regexpPrices, $response, $matches2, PREG_SET_ORDER); //
		  foreach ($matches2 as $key) {
				preg_match($regexpPrices2, $key[1], $matches);
				if (@$matches[1]) {
					if (strripos($key[1], 'submit-basket') !== false) {
						price_change_detect('http://' . ENGINE_CURR . trim($matches[1]), trim($matches[2]), trim($matches[3]), date("d.m.y-H:i:s"), $request->options[10004], $request->options[10006], $request->options[10018], ENGINE_CURR, ENGINE_TYPE);
						$itemsArray['http://' . ENGINE_CURR . trim($matches[1])] = array(trim($matches[2]), trim($matches[3]), date("d.m.y-H:i:s"), $request->options[10004]);		
						//echo trim($matches[1]) . "\n";
					} else {
						price_change_detect('http://' . ENGINE_CURR . trim($matches[1]), trim($matches[2]), '0', date("d.m.y-H:i:s"), $request->options[10004], $request->options[10006], $request->options[10018], ENGINE_CURR, ENGINE_TYPE);
						$itemsArray['http://' . ENGINE_CURR . trim($matches[1])] = array(trim($matches[2]), '0', date("d.m.y-H:i:s"), $request->options[10004]);		
						//echo trim($matches[1]) . " - null\n";						
					}
				} else {
					preg_match($regexpPrices3, $key[1], $matches);
					if (@$matches[1]) {
						price_change_detect('http://' . ENGINE_CURR . trim($matches[1]), trim($matches[2]), '0', date("d.m.y-H:i:s"), $request->options[10004], $request->options[10006], $request->options[10018], ENGINE_CURR, ENGINE_TYPE);
						$itemsArray['http://' . ENGINE_CURR . trim($matches[1])] = array(trim($matches[2]), '0', date("d.m.y-H:i:s"), $request->options[10004]);		
						//echo trim($matches[1]) . " - null\n";	
					}
				}
			}
		}	 					
  }
}
