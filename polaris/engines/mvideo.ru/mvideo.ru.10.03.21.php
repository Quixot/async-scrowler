<?php
/**
 * mvideo.ru Москва Новосибирск
 * $region_name = '';
 */
switch (EXTRA_PARAM) {
  case 'abakan': $region = 'CityDE_28838'; break;
  case 'almetevsk': $region = 'CityR_32'; break;
  case 'anapa': $region = 'CityR_119'; break;
  case 'angarsk': $region = 'CityR_145'; break;
  case 'apatity': $region = 'CityR_190'; break;
  case 'arzamas': $region = 'CityR_103'; break; 
  case 'armavir': $region = 'CityR_73'; break; 
  case 'arhangelsk': $region = 'CityCZ_9915'; $region_name = 'Архангельск'; break;
  case 'astrakhan': $region = 'CityCZ_6261'; break;
  case 'achinsk': $region = 'CityR_195'; break;
  case 'balakovo': $region = 'CityR_91'; break;
  case 'barnaul': $region = 'CityCZ_9912'; break;
  case 'belgorod': $region = 'CityCZ_15507'; break;
  case 'berezniki': $region = 'CityDE_31042'; break;
  case 'biysk': $region = 'CityR_90'; break;
  case 'borisoglebsk': $region = 'CityR_192'; break;
  case 'bratsk': $region = 'CityR_115'; break;
  case 'bryansk': $region = 'CityCZ_15535'; break;
  case 'velikijnovgorod': $region = 'CityDE_30978'; break;
  case 'vladikavkaz': $region = 'CityR_62'; break;
  case 'vladimir': $region = 'CityCZ_6899'; break;
  case 'volgodonsk': $region = 'CityR_54'; break;
  case 'volzhskij': $region = 'CityCZ_3062'; break;
  case 'vologda': $region = 'CityCZ_15577'; break;
  case 'gubkin': $region = 'CityR_64'; break;
  case 'derbent': $region = 'CityR_121'; break;
  case 'dimitrovgrad': $region = 'CityR_116'; break;
  case 'essentuki': $region = 'CityR_111'; break;
  case 'zheleznogorsk': $region = 'CityR_69'; break;
  case 'ivanovo': $region = 'CityCZ_15528'; break;
  case 'izhevsk': $region = 'CityCZ_6273'; break;
  case 'irkutsk': $region = 'CityCZ_11818'; break;
  case 'joshkar-ola': $region = 'CityR_72'; break;
  case 'kaluga': $region = 'CityR_106'; break;
  case 'kamyshin': $region = 'CityR_151'; break;
  case 'kasimov': $region = 'CityDE_31274'; break;
  case 'kemerovo': $region = 'CityCZ_9918'; break;
  case 'kirov': $region = 'CityCZ_15556'; break;
  case 'kislovodsk': $region = 'CityR_87'; break;
  case 'kostroma': $region = 'CityR_44'; break;
  case 'krasnoturinsk': $region = 'CityR_147'; break;
  case 'kropotkin': $region = 'CityR_125'; break;    
  case 'kurgan': $region = 'CityR_50'; break;
  case 'kursk': $region = 'CityCZ_7194'; break;
  case 'lipeck': $region = 'CityCZ_15500'; break;
  case 'lyantor': $region = 'CityR_110'; break;
  case 'magnitogorsk': $region = 'CityR_27'; break;
  case 'majkop': $region = 'CityR_114'; break;
  case 'mahachkala': $region = 'CityR_74'; break;
  case 'miass': $region = 'CityR_172'; break;
  case 'mineralnye-vody': $region = 'CityR_143'; break;
  case 'murmansk': $region = 'CityR_144'; break;
  case 'naberezhnye-chelny': $region = 'CityCZ_15563'; $region_name = 'Набережные Челны'; break;
  case 'nadym': $region = 'CityDE_28766'; break;
  case 'nalchik': $region = 'CityR_38'; break;
  case 'nevinnomyssk': $region = 'CityR_123'; break;
  case 'neftekamsk': $region = 'CityR_96'; break;
  case 'nefteyugansk': $region = 'CityR_61'; break;
  case 'nizhnevartovsk': $region = 'CityCZ_9969'; break;
  case 'nizhnekamsk': $region = 'CityR_46'; break;
  case 'nizhnij-tagil': $region = 'CityR_56'; break;
  case 'novokuzneck': $region = 'CityCZ_15584'; break;
  case 'novorossijsk': $region = 'CityCZ_6264'; break;
  case 'novotroick': $region = 'CityR_70'; break;
  case 'novocherkassk': $region = 'CityR_191'; break;
  case 'novyj-urengoj': $region = 'CityR_85'; break;
  case 'noyabrsk': $region = 'CityR_92'; break;
  case 'nyagan': $region = 'CityR_79'; break;
  case 'obninsk': $region = 'CityR_82'; break;
  case 'oktyabrskij': $region = 'CityCZ_15514'; break;
  case 'orel': $region = 'CityCZ_15542'; break;
  case 'orenburg': $region = 'CityCZ_6276'; break;
  case 'orsk': $region = 'CityCZ_15549'; break;
  case 'pavlovo': $region = '7300330'; break;
  case 'penza': $region = 'CityCZ_7182'; break;
  case 'pervouralsk': $region = 'CityR_93'; break;
  case 'petrozavodsk': $region = 'CityR_122'; $region_name = 'Петрозаводск'; break;
  case 'pskov': $region = 'CityR_49'; break;
  case 'pyatigorsk': $region = 'CityR_76'; $region_name = 'Пятигорск'; break;
  case 'revda': $region = 'CityR_149'; break;
  case 'rybinsk': $region = 'CityR_127'; break;
  case 'ryazan': $region = 'CityCZ_7179'; break;
  case 'salavat': $region = 'CityR_58'; break;
  case 'saransk': $region = 'CityR_95'; break;
  case 'saratov': $region = 'CityCZ_984'; break;
  case 'sarov': $region = 'CityR_126'; break;
  case 'severodvinsk': $region = 'CityR_120'; break;
  case 'seversk': $region = 'CityCZ_13165'; break;
  case 'smolensk': $region = 'CityR_124'; break;
  case 'solnechnogorsk': $region = 'CityCZ_35772'; break;
  case 'sochi': $region = 'CityCZ_6267'; break;
  case 'stavropol': $region = 'CityCZ_1370'; break;
  case 'staryj-oskol': $region = 'CityR_47'; break;
  case 'sterlitamak': $region = 'CityR_60'; break;
  case 'stupino': $region = 'CityDE_30890'; break;
  case 'surgut': $region = 'CityCZ_9963'; break;
  case 'syzran': $region = 'CityR_109'; break;
  case 'syktyvkar': $region = 'CityR_102'; break;
  case 'taganrog': $region = 'CityR_41'; break;
  case 'tambov': $region = 'CityCZ_15598'; break;
  case 'tver': $region = 'CityR_88'; break;
  case 'tobolsk': $region = 'CityR_105'; break;
  case 'tolyatti': $region = 'CityCZ_6270'; break;
  case 'tomsk': $region = 'CityCZ_9966'; break;
  case 'tuapse': $region = 'CityR_94'; break;
  case 'tula': $region = 'CityCZ_15521'; break;
  case 'tyumen': $region = 'CityCZ_1024'; break;
  case 'ulan-udeh': $region = 'CityR_98'; break;
  case 'ulyanovsk': $region = 'CityCZ_15570'; break;
  case 'uhta': $region = 'CityR_101'; break;
  case 'habarovsk': $region = 'CityDE_28834'; $region_name = 'Хабаровск'; break;
  case 'hanty-mansijsk': $region = 'CityR_34'; break;
  case 'cheboksary': $region = 'CityR_67'; $region_name = 'Чебоксары'; break;
  case 'cherepovec': $region = 'CityCZ_15591'; break;
  case 'cherkessk': $region = 'CityR_108'; break;
  case 'chita': $region = 'CityDE_28882'; break;
  case 'shahty': $region = 'CityR_189'; break;
  case 'ehngels': $region = 'CityCZ_2714'; break;
  case 'yugorsk': $region = 'CityDE_29162'; break;
  case 'yaroslavl': $region = 'CityCZ_7176'; break;
// Города - Миллионики
  case 'moscow': $region = 'CityCZ_975'; $region_name = 'Москва'; break;
  case 'spb': $region = 'CityCZ_1638'; $region_name = 'Санкт-Петербург'; break;    
 	case 'blagoveschensk': $region = 'CityDE_28702'; break;
  case 'rostov': $region = 'CityCZ_2446'; $region_name = 'Ростов-на-Дону'; break;    
  case 'novosibirsk': $region = 'CityCZ_2246'; $region_name = 'Новосибирск'; break;
 	case 'yekaterinburg': $region = 'CityCZ_2030'; $region_name = 'Екатеринбург'; break;
 	case 'chelyabinsk': $region = 'CityCZ_1216'; $region_name = 'Челябинск'; break;
 	case 'volgograd': $region = 'CityCZ_1272'; $region_name = 'Волгоград'; break; 	
 	case 'perm': $region = 'CityCZ_1250'; $region_name = 'Пермь'; break;
 	case 'kazan': $region = 'CityCZ_1458'; $region_name = 'Казань'; break;
 	case 'novgorod': $region = 'CityCZ_974'; $region_name = 'Нижний Новгород'; break; 		
 	case 'omsk': $region = 'CityCZ_9909'; $region_name = 'Омск'; break;
 	case 'samara': $region = 'CityCZ_1780'; $region_name = 'Самара'; break;
 	case 'ufa': $region = 'CityCZ_2534'; $region_name = 'Уфа'; break;
 	case 'kaliningrad': $region = 'CityR_146'; break;
 	case 'krasnoyarsk': $region = 'CityCZ_1854'; $region_name = 'Красноярск'; break;
 	case 'krasnodar': $region = 'CityCZ_2128'; $region_name = 'Краснодар'; break;
 	case 'voronezh': $region = 'CityCZ_7173'; $region_name = 'Воронеж'; break;
 	case 'vladivostok': $region = 'CityDE_31146'; $region_name = 'Владивосток'; break;
 	case 'yakutsk': $region = 'CityR_104'; break;
 	default:
 		die("Unknown region\n");    	
}

// Костыль
switch (ENGINE_TYPE) {
	case 'vitek': 	$pagin = '3'; break;
	case 'maxwell': $pagin = '1'; break;
	case 'rondell': $pagin = '2'; break;
	case 'polaris': $pagin = '16'; break;
 	default: $pagin = '1'; break;	
}

$urlStart 		= 'https://www.mvideo.ru/product-list?Dy=1&No=';						// Первая часть адреса
$urlEnd				= '&Nrpp=24&Nty=1&Ntt=' . ENGINE_TYPE;							 				// Вторая часть адреа и поисковая строка
//$regexpPagin	= "~class=\"search-results-heading-qty\">(.+)</span>~isU"; 	// К-во найденых товаров
$regexpPrices = "~class=\"product-tile-picture(.+)<div class=\"product-tile-gift-card\">~isU"; // Все товары на странице
$regexpPrices_alt = "~c-product-tile(.+)</script>~isU"; // Все товары на странице

if (EXTRA_PARAM == 'kazan' ||  EXTRA_PARAM == 'rostov' || EXTRA_PARAM == 'novosibirsk' || EXTRA_PARAM == 'yekaterinburg') {
	$regexpPrices = "~product-card__labels(.+)product-supplier><!----></div><!---->~isU";
	$regexpPrices2 = "~product-title__text.*href=\"(.+)\".*>(.+)<.*class=\"price__main-value.*>(.+)<~isU";
	$regexpPrices3 = "~product-title__text.*href=\"(.+)\".*>(.+)<~isU";
} else {
	$regexpPrices2 = "~class=\"product-tile-description\".*href=\"(.+)\".*>(.+)<.*class=\"product-price-current.*>(.+)<~isU";
	$regexpPrices3 = "~class=\"product-tile-description\".*href=\"(.+)\".*>(.+)<~isU"; // Режем карточки товара
}




// Загрузка отсканированных ссылок:
foreach ($itemsArray as $key => $value) {
	$date = DateTime::createFromFormat('d.m.y-H:i:s', $value[2]);
	//echo (time() - $date->format('U')).PHP_EOL; 
	if (time() - $date->format('U') <= 18000) {
		$already_scanned[] = $value[5];
	}
	
}
if ($already_scanned) {
	$already_scanned = array_unique($already_scanned);
	$already_scanned = array_values($already_scanned);
	//print_r($already_scanned); 
} else {
	$already_scanned = array();
}


$pagin_array = range(0, 3);
shuffle($pagin_array);

if (EXTRA_PARAM == 'kazan' || EXTRA_PARAM == 'rostov' || EXTRA_PARAM == 'novosibirsk' || EXTRA_PARAM == 'yekaterinburg') {
	$somelinks = array(
		'https://www.mvideo.ru/product-list-page?q=polaris&category=elektrochainiki-96&showCount=72',
		);
	foreach ($somelinks as $url) {
		if (!in_array($url, $already_scanned)) {
			$i = 1;
			echo 'сканирую адрес:'.PHP_EOL.$url.PHP_EOL;
			while ( regular_one($url)<1 && $i<5 ) {
				$i++;
			}
		} else {
			echo 'уже сканировал:'.PHP_EOL.$url.PHP_EOL;
		}
	}	
} else {
	while (list(, $number) = each($pagin_array)) {
		$url = 'https://www.mvideo.ru/product-list?Dy=1&No='.($number*12).'&Nrpp=24&Nty=1&Ntt=polaris&cityId='.$region;
		if (!in_array($url, $already_scanned)) {
			$i = 1;
			echo 'сканирую адрес:'.PHP_EOL.$url.PHP_EOL;
			while ( regular_one($url)<1 && $i<5 ) {
				$i++;
			}
		} else {
			echo 'уже сканировал:'.PHP_EOL.$url.PHP_EOL;
		}
	}
}

/**
 * Формируем CSV файл
 */
file_put_contents(AC_DIR . DIRECTORY_SEPARATOR . 'engines' . DIRECTORY_SEPARATOR . ENGINE_CURR . DIRECTORY_SEPARATOR . 'data' . DIRECTORY_SEPARATOR . date("d.m.y") . '_' . ENGINE_CURR . '_' . ENGINE_TYPE . '_' . EXTRA_PARAM . '.data', serialize($itemsArray));
$filename = AC_DIR . DIRECTORY_SEPARATOR . 'reports' . DIRECTORY_SEPARATOR . ENGINE_CURR . '_' . ENGINE_TYPE . '_' . EXTRA_PARAM . '.csv';

/** 
 *              Callback Functions           
 */
function regular_one($url) {
	global $regexpPrices;
	global $regexpPrices_alt;
	global $regexpPrices2;
	global $regexpPrices3;
	global $itemsArray;
	global $region;
	global $region_name;
	global $pagin;
	global $domain;


	$proxarr = get_proxy_and_ua('/var/www/lib/proxies/*.proxy', '/var/www/lib/useragents_short.txt');

	

	$cmd = 'timeout -k 50s 51s casperjs /var/www/polaris/engines/mvideo.ru/mvideo.js '.escapeshellarg($url).' '.escapeshellarg($proxarr['ua']).' '.$proxarr['address'].' '.$proxarr['port'].' '.$proxarr['login'].' '.$proxarr['password'].' '.$region.' '.$pagin.' '.ENGINE_TYPE;

	echo $cmd.PHP_EOL;
	$response = exec($cmd, $out, $err);
	$response = stripcslashes($response);

	if (EXTRA_PARAM == 'kazan') {
		file_put_contents('/var/www/polaris/engines/mvideo.ru/content.txt', $response);
	}
	
	//die();
	if (strlen($response) > 500) {
		echo 'response ok'.PHP_EOL;

		preg_match("~class=\"header-sities-link region-opener sel-button-region\">(.+)<~isU", $response, $region_m);
		if (!trim($region_m[1])) {
			preg_match("~location-text top-navbar-link.*>(.+)<~isU", $response, $region_m);
		}
		$region_m[1] = trim($region_m[1]);
		echo 'request  region: '.$region_name.PHP_EOL;
		echo 'response region: '.$region_m[1].PHP_EOL;
		//sleep(5);

  	// Проверка региона
  	if ($region_m[1] != $region_name) {
  		echo 'Регионы не совпадают'.PHP_EOL;
  		return 0;
  	}		

		preg_match_all($regexpPrices, $response, $matches2, PREG_SET_ORDER); //
		if (!$matches2) {
			preg_match_all($regexpPrices_alt, $response, $matches2, PREG_SET_ORDER); //
		}
	  print_r($matches2);
	  $is_inf = 0;
	  foreach ($matches2 as $key) {
			preg_match($regexpPrices2, $key[1], $matches);
			print_r($matches);
			if (@$matches[1]) {
				$matches[1] = trim($matches[1]);
				$matches[2] = strip_tags($matches[2]);
				$matches[2] = trim($matches[2]);
				$matches[3] = preg_replace('~[^\d.]+~', '' , $matches[3]);

				if (strripos($key[1], 'В корзину') !== false) {
					price_change_detect($matches[1], $matches[2], $matches[3], date("d.m.y-H:i:s"), $proxarr['address'].':'.$proxarr['port'], $proxarr['login'].':'.$proxarr['password'], $proxarr['ua'], ENGINE_CURR, ENGINE_TYPE);
					$itemsArray[$matches[1]] = array($matches[2], $matches[3], date("d.m.y-H:i:s"), $proxarr['address'].':'.$proxarr['port'], $proxarr['ua'], $url);		
					AngryCurl::add_debug_msg($matches[1].' | '.$matches[2].' | '.$matches[3]);
				} else {
					price_change_detect('http://' . ENGINE_CURR . trim($matches[1]), trim($matches[2]), '0', date("d.m.y-H:i:s"), $proxarr['address'].':'.$proxarr['port'], $proxarr['login'].':'.$proxarr['password'], $proxarr['ua'], ENGINE_CURR, ENGINE_TYPE);
					$itemsArray['http://' . ENGINE_CURR . trim($matches[1])] = array(trim($matches[2]), '0', date("d.m.y-H:i:s"), $proxarr['address'].':'.$proxarr['port'], $proxarr['ua'], $url);		

					AngryCurl::add_debug_msg($matches[1].' | '.$matches[2].' | '.$matches[3]);						
				}
				$is_inf = 1;
			} else {
				preg_match($regexpPrices3, $key[1], $matches);
				if (@$matches[1]) {
					$matches[1] = trim($matches[1]);
					$matches[2] = strip_tags($matches[2]);
					$matches[2] = trim($matches[2]);
					$matches[3] = preg_replace('~[^\d.]+~', '' , $matches[3]);

					price_change_detect($matches[1], $matches[2], '0', date("d.m.y-H:i:s"), $proxarr['address'].':'.$proxarr['port'], $proxarr['login'].':'.$proxarr['password'], $proxarr['ua'], ENGINE_CURR, ENGINE_TYPE);
					$itemsArray[$matches[1]] = array($matches[2], '0', date("d.m.y-H:i:s"), $proxarr['address'].':'.$proxarr['port'], $proxarr['ua'], $url);		

					AngryCurl::add_debug_msg($matches[1].' | '.$matches[2].' | '.$matches[3]);
				}
				$is_inf = 1;
			}
		}
		if ($is_inf > 0) {		
			file_put_contents(AC_DIR.'/engines/'.ENGINE_CURR.'/data/'.date("d.m.y").'_'.ENGINE_CURR.'_'.ENGINE_TYPE.'_'.EXTRA_PARAM.'.data', serialize($itemsArray));
		}
		return 1;
	} else {
		echo substr($response, 0, 500);
		echo 'bad response'.PHP_EOL;
		return 0;
	}
}
