<?php
switch (EXTRA_PARAM) {
  case 'moscow': 
  	$region = '11324';
  	$regionRu = 'Москва и Подмосковье';
    break;
  case 'spb':
    $region = '11279';
    $regionRu = 'Санкт-Петербург';
    break;
  case 'rostov':
  	$region = '11299';
  	$regionRu = 'Ростов-на-Дону';
    break;
  case 'novosibirsk':
  	$region = '11290';
  	$regionRu = 'Новосибирск';
  	break;
 	case 'yekaterinburg':
 		$region = '11297';
 		$regionRu = 'Екатеринбург';
 		break;
 	case 'chelyabinsk':
 		$region = '11298';
 		$regionRu = 'Челябинск';
 		break;
 	case 'volgograd':
 		$region = '11306';
 		$regionRu = 'Волгоград';
 		break; 
 	case 'perm':
 		$region = '11296';
 		$regionRu = 'Пермь';
 		break; 
 	case 'kazan':
 		$region = '11281';
 		$regionRu = 'Казань';
 		break; 
 	case 'novgorod':
 		$region = '11289';
 		$regionRu = 'Нижний Новгород';
 		break; 
 	case 'omsk':
 		$region = '11293';
 		$regionRu = 'Омск';
 		break;
 	case 'samara':
 		$region = '11288';
 		$regionRu = 'Самара';
 		break;
 	case 'ufa':
 		$region = '11285';
 		$regionRu = 'Уфа';
 		break;
 	case 'krasnoyarsk':
 		$region = '11294';
 		$regionRu = 'Красноярск';
 		break;
 	case 'krasnodar':
 		$region = '11300';
 		$regionRu = 'Краснодар';
 		break;
 	case 'voronezh':
 		$region = '11302';
 		$regionRu = 'Воронеж';
 		break;
 	case 'vladivostok':
 		$region = '11389';
 		$regionRu = 'Владивосток';
 		break; 
 	case 'arhangelsk':
 		$region = '11308';
 		$regionRu = 'Архангельск';
 		break; 
 	case 'astrakhan':
 		$region = '11346';
 		$regionRu = 'Астрахань';
 		break; 
 	case 'barnaul':
 		$region = '11317';
 		$regionRu = 'Барнаул';
 		break; 
  case 'belgorod':
 		$region = '11303';
 		$regionRu = 'Белгород';
 		break; 
 	case 'bryansk':
 		$region = '11342';
 		$regionRu = 'Брянск';
 		break; 
 	case 'velikijnovgorod':
 		$region = '17120';
 		$regionRu = 'Великий Новгород';
 		break;
 	case 'vladimir':
 		$region = '11369';
 		$regionRu = 'Владимир';
 		break; 
 	case 'vologda':
 		$region = '11386';
 		$regionRu = 'Вологда';
 		break; 
 	case 'ivanovo':
 		$region = '11328';
 		$regionRu = 'Иваново';
 		break; 
 	case 'izhevsk':
 		$region = '11282';
 		$regionRu = 'Ижевск';
 		break;
 	case 'irkutsk':
 		$region = '11320';
 		$regionRu = 'Иркутск';
 		break;
 	case 'kaluga':
 		$region = '11366';
 		$regionRu = 'Калуга';
 		break;
 	case 'kemerovo':
 		$region = '11311';
 		$regionRu = 'Кемерово';
 		break;
 	case 'kirov':
 		$region = '11365';
 		$regionRu = 'Киров';
 		break;
 	case 'kostroma':
 		$region = '11326';
 		$regionRu = 'Кострома';
 		break;
 	case 'kursk':
 		$region = '11304';
 		$regionRu = 'Курск';
 		break;
 	case 'lipeck':
 		$region = '11305';
 		$regionRu = 'Липецк';
 		break;
 	case 'murmansk':
 		$region = '11377';
 		$regionRu = 'Мурманск';
 		break;
 	case 'naberezhnye-chelny':
 		$region = '11284';
 		$regionRu = 'Набережные Челны';
 		break;
 	case 'nalchik':
 		$region = '12576';
 		$regionRu = 'Нальчик';
 		break;
 	case 'novokuzneck':
 		$region = '11295';
 		$regionRu = 'Новокузнецк';
 		break;
 	case 'novorossijsk':
 		$region = '11351';
 		$regionRu = 'Новороссийск';
 		break;
 	case 'novocherkassk':
 		$region = '11373';
 		$regionRu = 'Новочеркасск';
 		break;
 	case 'orel':
 		$region = '12210';
 		$regionRu = 'Орёл';
 		break;
 	case 'orenburg':
 		$region = '11341';
 		$regionRu = 'Оренбург';
 		break;
 	case 'penza':
 		$region = '11321';
 		$regionRu = 'Пенза';
 		break;
 	case 'pskov':
 		$region = '11348';
 		$regionRu = 'Псков';
 		break;
 	case 'ryazan':
 		$region = '11360';
 		$regionRu = 'Рязань';
 		break;
 	case 'saransk':
 		$region = '11343';
 		$regionRu = 'Саранск';
 		break;
 	case 'saratov':
 		$region = '11325';
 		$regionRu = 'Саратов';
 		break;
 	case 'severodvinsk':
 		$region = '11323';
 		$regionRu = 'Северодвинск';
 		break;
 	case 'smolensk':
 		$region = '11310';
 		$regionRu = 'Смоленск';
 		break;
 	case 'sochi':
 		$region = '11301';
 		$regionRu = 'Сочи';
 		break;
 	case 'stavropol':
 		$region = '11330';
 		$regionRu = 'Ставрополь';
 		break;
 	case 'surgut':
 		$region = '11327';
 		$regionRu = 'Сургут';
 		break;
 	case 'syzran':
 		$region = '11935';
 		$regionRu = 'Сызрань';
 		break;
 	case 'tambov':
 		$region = '11318';
 		$regionRu = 'Тамбов';
 		break;
 	case 'tver':
 		$region = '11357';
 		$regionRu = 'Тверь';
 		break;
 	case 'tolyatti':
 		$region = '11339';
 		$regionRu = 'Тольятти';
 		break;
 	case 'tomsk':
 		$region = '11292';
 		$regionRu = 'Томск';
 		break;
 	case 'tula':
 		$region = '11374';
 		$regionRu = 'Тула';
 		break;
 	case 'tyumen':
 		$region = '11334';
 		$regionRu = 'Тюмень';
 		break;
 	case 'ulyanovsk':
 		$region = '11349';
 		$regionRu = 'Ульяновск';
 		break;
 	case 'cheboksary':
 		$region = '11312';
 		$regionRu = 'Чебоксары';
 		break;
 	case 'cherepovec':
 		$region = '11345';
 		$regionRu = 'Череповец';
 		break;
 	case 'yakutsk':
 		$region = '11919';
 		$regionRu = 'Якутск';
 		break;
 	case 'yaroslavl':
 		$region = '11372';
 		$regionRu = 'Ярославль';
 		break;
 		default:
 		die("Unknown region\n");  	 		
}

	$regexpPrices1 = "~<li class=\"ED\" data-id=\"(.+)</div></div></li>~isU";
	$regexpPrices2 = "~href=\"(.+)\".*title=\"(.+)\".*data-pc=\"offer_price\">(.+)<~isU";
	$regexpPrices3 = "~href=\"(.+)\".*title=\"(.+)\"~isU";
	$regexpRegion = "~class=\"mi\">(.+)<~isU";
	$itemsArray = array();

	$AC = new AngryCurl('callback_two');
	$AC->init_console();
	callback_two($response);

	function callback_two($response) {
	global $regexpPrices1;
	global $regexpPrices2;
	global $regexpPrices3;
	global $itemsArray;
	global $errorsArray;
	global $bad_urls;
	global $regexpRegion;
	global $regionRu;
	global $guide;

	if ($response) {
		echo 'response ok'.PHP_EOL;

  	preg_match($regexpRegion, $response, $mregion);
  	$mregion[1] =  trim($mregion[1]);
  	AngryCurl::add_debug_msg($mregion[1].' | '.$regionRu);

  	if (stripos($mregion[1], $regionRu) !== false) {
	  	preg_match_all($regexpPrices1, $response, $matches2, PREG_SET_ORDER);
	  	//print_r($matches2);
			foreach ($matches2 as $key) {
				if (stripos($key[1], 'Добавить в корзину') !== false) {
					preg_match($regexpPrices2, $key[1], $matches);
					$matches[1] = 'https://www.'.ENGINE_CURR.trim($matches[1]);

					$matches = clean_info($matches, array(1,2,3), 'utf-8');
					price_change_detect($matches[1], $matches[2], $matches[3], date("d.m.y-H:i:s"), 'manual', 'manual', 'manual', ENGINE_CURR, ENGINE_TYPE);
					$itemsArray[$matches[1]] = array(
						$matches[2], 
						$matches[3],
						date("d.m.y-H:i:s"),
						'manual',
						'manual',
						'manual'
					);			
					AngryCurl::add_debug_msg($matches[1].' | '.$matches[2].' | '.$matches[3]);
				} else {
					preg_match($regexpPrices3, $key[1], $matches);
					$matches[1] = 'https://www.'.ENGINE_CURR.trim($matches[1]);
					$matches[3] = 0;
					$matches = clean_info($matches, array(1,2,3), 'utf-8');
					price_change_detect($matches[1], $matches[2], $matches[3], date("d.m.y-H:i:s"), 'manual', 'manual', 'manual', ENGINE_CURR, ENGINE_TYPE);
					$itemsArray[$matches[1]] = array(
						$matches[2], 
						$matches[3],
						date("d.m.y-H:i:s"),
						'manual',
						'manual',
						'manual'
					);			
					AngryCurl::add_debug_msg($matches[1].' | '.$matches[2].' | 0');
				}
			} 
		} else {
			AngryCurl::add_debug_msg('Регион не совпадает');
			$bad_urls['manual'] = array(
    		$info['http_code'],
    		'manual'
    	);
		} 	
  
		return 1;
	} else {
		echo 'bad response'.PHP_EOL;
		return 0;
	}
}