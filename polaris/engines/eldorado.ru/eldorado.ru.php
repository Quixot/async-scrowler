<?php
/**
 * eldorado.ru
 */
switch (EXTRA_PARAM) {
  case 'moscow': 
  	$region = '11324';
  	$regionRu = 'Москва';
    break;
  case 'spb':
    $region = '11279';
    $regionRu = 'Санкт-Петербург';
    break;
  case 'rostov':
  	$region = '11299';
  	$regionRu = 'Ростов-на-Дону';
    break;
  case 'novosibirsk':
  	$region = '11290';
  	$regionRu = 'Новосибирск';
  	break;
 	case 'yekaterinburg':
 		$region = '11297';
 		$regionRu = 'Екатеринбург';
 		break;
 	case 'chelyabinsk':
 		$region = '11298';
 		$regionRu = 'Челябинск';
 		break;
 	case 'volgograd':
 		$region = '11306';
 		$regionRu = 'Волгоград';
 		break; 
 	case 'perm':
 		$region = '36166';
 		$regionRu = 'Пермь';
 		break; 
 	case 'kazan':
 		$region = '11281';
 		$regionRu = 'Казань';
 		break; 
 	case 'novgorod':
 		$region = '36186';
 		$regionRu = 'Нижний Новгород';
 		break; 
 	case 'omsk':
 		$region = '11293';
 		$regionRu = 'Омск';
 		break;
 	case 'samara':
 		$region = '11288';
 		$regionRu = 'Самара';
 		break;
 	case 'ufa':
 		$region = '11285';
 		$regionRu = 'Уфа';
 		break;
 	case 'krasnoyarsk':
 		$region = '11294';
 		$regionRu = 'Красноярск';
 		break;
 	case 'krasnodar':
 		$region = '11300';
 		$regionRu = 'Краснодар';
 		break;
 	case 'voronezh':
 		$region = '11302';
 		$regionRu = 'Воронеж';
 		break;
 	case 'vladivostok':
 		$region = '11389';
 		$regionRu = 'Владивосток';
 		break; 
 	case 'arhangelsk':
 		$region = '11308';
 		$regionRu = 'Архангельск';
 		break; 
 	case 'astrakhan':
 		$region = '11346';
 		$regionRu = 'Астрахань';
 		break; 
 	case 'barnaul':
 		$region = '11317';
 		$regionRu = 'Барнаул';
 		break; 
  case 'belgorod':
 		$region = '11303';
 		$regionRu = 'Белгород';
 		break; 
 	case 'bryansk':
 		$region = '11342';
 		$regionRu = 'Брянск';
 		break; 
 	case 'velikijnovgorod':
 		$region = '17120';
 		$regionRu = 'Великий Новгород';
 		break;
 	case 'vladimir':
 		$region = '11369';
 		$regionRu = 'Владимир';
 		break; 
 	case 'vologda':
 		$region = '11386';
 		$regionRu = 'Вологда';
 		break; 
 	case 'ivanovo':
 		$region = '11328';
 		$regionRu = 'Иваново';
 		break; 
 	case 'izhevsk':
 		$region = '11282';
 		$regionRu = 'Ижевск';
 		break;
 	case 'irkutsk':
 		$region = '11320';
 		$regionRu = 'Иркутск';
 		break;
 	case 'kaluga':
 		$region = '11366';
 		$regionRu = 'Калуга';
 		break;
 	case 'kemerovo':
 		$region = '11311';
 		$regionRu = 'Кемерово';
 		break;
 	case 'kirov':
 		$region = '11365';
 		$regionRu = 'Киров';
 		break;
 	case 'kostroma':
 		$region = '11326';
 		$regionRu = 'Кострома';
 		break;
 	case 'kursk':
 		$region = '11304';
 		$regionRu = 'Курск';
 		break;
 	case 'lipeck':
 		$region = '11305';
 		$regionRu = 'Липецк';
 		break;
 	case 'murmansk':
 		$region = '11377';
 		$regionRu = 'Мурманск';
 		break;
 	case 'naberezhnye-chelny':
 		$region = '11284';
 		$regionRu = 'Набережные Челны';
 		break;
 	case 'nalchik':
 		$region = '12576';
 		$regionRu = 'Нальчик';
 		break;
 	case 'novokuzneck':
 		$region = '11295';
 		$regionRu = 'Новокузнецк';
 		break;
 	case 'novorossijsk':
 		$region = '11351';
 		$regionRu = 'Новороссийск';
 		break;
 	case 'novocherkassk':
 		$region = '11373';
 		$regionRu = 'Новочеркасск';
 		break;
 	case 'orel':
 		$region = '12210';
 		$regionRu = 'Орёл';
 		break;
 	case 'orenburg':
 		$region = '11341';
 		$regionRu = 'Оренбург';
 		break;
 	case 'penza':
 		$region = '11321';
 		$regionRu = 'Пенза';
 		break;
 	case 'pskov':
 		$region = '11348';
 		$regionRu = 'Псков';
 		break;
 	case 'ryazan':
 		$region = '11360';
 		$regionRu = 'Рязань';
 		break;
 	case 'saransk':
 		$region = '11343';
 		$regionRu = 'Саранск';
 		break;
 	case 'saratov':
 		$region = '11325';
 		$regionRu = 'Саратов';
 		break;
 	case 'severodvinsk':
 		$region = '11323';
 		$regionRu = 'Северодвинск';
 		break;
 	case 'smolensk':
 		$region = '11310';
 		$regionRu = 'Смоленск';
 		break;
 	case 'sochi':
 		$region = '11301';
 		$regionRu = 'Сочи';
 		break;
 	case 'stavropol':
 		$region = '11330';
 		$regionRu = 'Ставрополь';
 		break;
 	case 'surgut':
 		$region = '11327';
 		$regionRu = 'Сургут';
 		break;
 	case 'syzran':
 		$region = '11935';
 		$regionRu = 'Сызрань';
 		break;
 	case 'tambov':
 		$region = '11318';
 		$regionRu = 'Тамбов';
 		break;
 	case 'tver':
 		$region = '11357';
 		$regionRu = 'Тверь';
 		break;
 	case 'tolyatti':
 		$region = '11339';
 		$regionRu = 'Тольятти';
 		break;
 	case 'tomsk':
 		$region = '11292';
 		$regionRu = 'Томск';
 		break;
 	case 'tula':
 		$region = '11374';
 		$regionRu = 'Тула';
 		break;
 	case 'tyumen':
 		$region = '11334';
 		$regionRu = 'Тюмень';
 		break;
 	case 'ulyanovsk':
 		$region = '11349';
 		$regionRu = 'Ульяновск';
 		break;
 	case 'cheboksary':
 		$region = '11312';
 		$regionRu = 'Чебоксары';
 		break;
 	case 'cherepovec':
 		$region = '11345';
 		$regionRu = 'Череповец';
 		break;
 	case 'yakutsk':
 		$region = '11919';
 		$regionRu = 'Якутск';
 		break;
 	case 'yaroslavl':
 		$region = '11372';
 		$regionRu = 'Ярославль';
 		break;
 		default:
 		die("Unknown region\n");  	 		
}

	//$urlStart 		 = 'https://www.eldorado.ru/search/catalog.php?PAGEN_SEARCH=';
	//$urlEnd				 = '&list_num=36&q='.ENGINE_TYPE;
	$url = 'https://www.eldorado.ru/search/catalog.php?q=polaris&list_num=36&PAGEN_SEARCH=';


	$regexpP1 = "~<li class=\"previous(.+)</ul>~isU";
	$regexpP2 = "~<a.*>(.+)<~isU";

	$regexpPrices1 = "~data-id=\"(.+)</div></div></li>~isU";
	$regexpPrices2 = "~href=\"(.+)\".*title=\"(.+)\".*data-pc=\"offer_price\">(.+)<~isU";
	$regexpPrices3 = "~href=\"(.+)\".*title=\"(.+)\"~isU";
	$regexpRegion = "~class=\"mi\">(.+)<~isU";
	$regexpRegion  = '~timezoneOffset".*"title":"(.+)"~isU';

	if (ENGINE_LOOP == 13) {
		$regions = array('cheboksary', 'chelyabinsk', 'habarovsk', 'kazan', 'krasnodar', 'krasnoyarsk', 'moscow', 'naberezhnye-chelny', 'novgorod', 'novosibirsk', 'omsk', 'rostov', 'spb', 'samara', 'ufa', 'volgograd', 'vladivostok', 'yekaterinburg');

		foreach ($regions as $region) {

			$content_file_path = '/var/www/polaris/engines/eldorado.ru/content/'.$region.'.txt';
			if (file_exists($content_file_path) && time() - filemtime($content_file_path) < 13600) {

				$itemsArray = array();

				$AC = new AngryCurl('callback_three');
				$AC->init_console();
				$response = file_get_contents($content_file_path);

				callback_three($response, $region);

				file_put_contents(AC_DIR . DIRECTORY_SEPARATOR . 'engines' . DIRECTORY_SEPARATOR . ENGINE_CURR . DIRECTORY_SEPARATOR . 'data' . DIRECTORY_SEPARATOR . date("d.m.y") . '_' . ENGINE_CURR . '_' . ENGINE_TYPE . '_' . $region . '.data', serialize($itemsArray));
			} else {
				echo 'Старый файл: '.$content_file_path.PHP_EOL;
			}
		}
		$filename = AC_DIR . DIRECTORY_SEPARATOR . 'reports' . DIRECTORY_SEPARATOR . ENGINE_CURR . '_' . ENGINE_TYPE . '_' . EXTRA_PARAM . '.csv';

	} else {	

if (EXTRA_PARAM == 'moscow') {
	$options = array(
       	//CURLOPT_COOKIEFILE      => '/var/www/polaris/engines/beru.ru/cookiessss_'.EXTRA_PARAM.'.txt',
       	CURLOPT_COOKIEJAR      	=> '/var/www/polaris/engines/eldorado.ru/cookies/xxx/'.EXTRA_PARAM.'.txt',
       	//CURLOPT_COOKIE 					=> 'iRegionSectionId='.$region,
        CURLOPT_AUTOREFERER     => true,
        CURLOPT_FOLLOWLOCATION  => true,
        CURLOPT_RETURNTRANSFER  => true,
				CURLOPT_CONNECTTIMEOUT => 30,
				CURLOPT_TIMEOUT        => 30, 
				CURLOPT_SSL_VERIFYPEER => 0,
        CURLOPT_SSL_VERIFYHOST => 0   
    );
} else {
	$options = array(
       	CURLOPT_COOKIEFILE      => '/var/www/polaris/engines/eldorado.ru/cookies/'.EXTRA_PARAM.'.txt',
       	CURLOPT_COOKIEJAR      	=> '/var/www/polaris/engines/eldorado.ru/cookies/xxx/'.EXTRA_PARAM.'.txt',
       	//CURLOPT_COOKIE 					=> 'iRegionSectionId='.$region,
        CURLOPT_AUTOREFERER     => true,
        CURLOPT_FOLLOWLOCATION  => true,
        CURLOPT_RETURNTRANSFER  => true,
				CURLOPT_CONNECTTIMEOUT => 30,
				CURLOPT_TIMEOUT        => 30, 
				CURLOPT_SSL_VERIFYPEER => 0,
        CURLOPT_SSL_VERIFYHOST => 0   
    );
	//echo file_get_contents('/var/www/polaris/engines/eldorado.ru/cookies/'.EXTRA_PARAM.'.txt');
}

	// Загрузка отсканированных ссылок:
	foreach ($itemsArray as $key => $value) {
		$date = DateTime::createFromFormat('d.m.y-H:i:s', $value[2]);
		//echo (time() - $date->format('U')).PHP_EOL; 
		if (time() - $date->format('U') <= 5400) {
			$already_scanned[] = trim($value[5]);
		}
		
	}
	if ($already_scanned) {
		$already_scanned = array_unique($already_scanned);
		$already_scanned = array_values($already_scanned);
		print_r($already_scanned); 
	} else {
		$already_scanned = array();
	}
	//$already_scanned = array(); $itemsArray = array();

	$AC->get('https://www.eldorado.ru/search/catalog.php?q=polaris&utf', null, $options);
	//$AC->get('https://www.eldorado.ru/search/catalog.php?q=polaris&offset=36&utf', null, $options);         
	$AC->execute(WINDOW_SIZE);

	while ($bad_urls) {
		$AC->flush_requests();
		foreach ($bad_urls as $urls) {
		  $AC->get($urls, NULL, $options);
		}
		unset($urls);
		$bad_urls = array();
		$AC->execute(WINDOW_SIZE);
		unset($urls);
	}	

	if ($qOfPaginationPages > 1) {
		$is_scan = 0;
					for ($i=1; $i < $qOfPaginationPages; $i++) { 
						if (!in_array('https://www.eldorado.ru/search/catalog.php?q=polaris&offset='.($i*36).'&utf', $already_scanned)) {
							echo 'сканирую адрес:'.PHP_EOL.'https://www.eldorado.ru/search/catalog.php?q=polaris&offset='.($i*36).'&utf'.PHP_EOL;
							$AC->get('https://www.eldorado.ru/search/catalog.php?q=polaris&offset='.($i*36).'&utf', NULL, $options);
							$is_scan = 1;
						} else {
							echo 'уже сканировал:'.PHP_EOL.'https://www.eldorado.ru/search/catalog.php?q=polaris&offset='.($i*36).'&utf'.PHP_EOL;
						}
					}
					if ($is_scan) {
						$AC->execute(WINDOW_SIZE);
					}
					

					while ($bad_urls) {      // Перебираем заново адреса, не вернувшие контент
						  $AC->flush_requests(); // Чистим массив запросов
						  foreach ($bad_urls as $urls) { // Готовим новый цикл из битых URLs
						    $AC->get($urls, NULL, $options);
						  }
						  unset($urls);
						  $bad_urls = array();       // Чистим массив URL-ов для следующего (возможного) цикла    
						  $AC->execute(WINDOW_SIZE); // Запускаем цикл, пока последний адрес не вернёт контент. Нужно придумать условия выхода!!!!!
						}	
					unset($urls);
	}

	file_put_contents(AC_DIR . DIRECTORY_SEPARATOR . 'engines' . DIRECTORY_SEPARATOR . ENGINE_CURR . DIRECTORY_SEPARATOR . 'data' . DIRECTORY_SEPARATOR . date("d.m.y") . '_' . ENGINE_CURR . '_' . ENGINE_TYPE . '_' . EXTRA_PARAM . '.data', serialize($itemsArray));
	$filename = AC_DIR . DIRECTORY_SEPARATOR . 'reports' . DIRECTORY_SEPARATOR . ENGINE_CURR . '_' . ENGINE_TYPE . '_' . EXTRA_PARAM . '.csv';
}

/**
 *              Callback Functions           
 */
function callback_three($response, $region) {
  global $regexpP1;
  global $regexpP2;

  global $regexpPrices1;
  global $regexpPrices2;
  global $regexpPrices3;

  global $qOfPaginationPages;

  global $itemsArray;
  global $region;
	global $regexpRegion;
	global $regionRu;
	global $time_start;
	global $site_links;

	global $bad_urls;


	AngryCurl::add_debug_msg(PHP_EOL.$request->url);
	AngryCurl::add_debug_msg($info['http_code']);
	AngryCurl::add_debug_msg($request->options[10004]); 

  if ($response) {


		preg_match($regexpRegion, $response, $region_name);
		//print_r($region_name);
		//$region_name[1] = trim(iconv("windows-1251", "UTF-8", $region_name[1]));
		echo 'request  region: '.$regionRu.PHP_EOL;
		echo 'response region: '.$region_name[1].PHP_EOL;	

		if (1 == 1) { // stripos(haystack, needle) stripos($region_name[1], $regionRu) !== false

				preg_match($regexpP1, $response, $matches);
				//print_r($matches);
				preg_match_all($regexpP2, $matches[1], $matches2);
				//print_r($matches2);
				$temparrpage = array();
				foreach ($matches2[1] as $key => $value) {
					//echo "key: " . $key . "\n";
					echo "value:" . $value . "\n";
					if (is_numeric($value)) {
						$temparrpage[] = $value;
					}
				}

				if (@max($temparrpage) > $qOfPaginationPages) {
					$qOfPaginationPages = @max($temparrpage);	    	
				}
				echo 'Страниц: '.$qOfPaginationPages.PHP_EOL;


	  	preg_match_all($regexpPrices1, $response, $matches_items, PREG_SET_ORDER);
	  	//print_r($matches_items);


	  	foreach ($matches_items as $key) {
		  	if (strripos($key[0], 'Добавить в корзину') !== false) {
						preg_match($regexpPrices2, $key[0], $matches);
						//print_r($matches);

						$matches[1] = 'https://www.eldorado.ru'.trim($matches[1]);
						$matches[2] = trim($matches[2]);
						$matches[3] = preg_replace('~[^\d]+~', '' , $matches[3]);	

						if ($matches[1] && $matches[2]) {
							price_change_detect($matches[1], $matches[2], $matches[3], date("d.m.y-H:i:s"), $request->options[10004], $request->options[10006], $request->options[10018], ENGINE_CURR, ENGINE_TYPE);
							$itemsArray[trim($matches[1])] = array(
								$matches[2], 
								$matches[3],
								date("d.m.y-H:i:s"),
								$request->options[10004],
								$request->options[10018],
								$request->url
							);
						}
					AngryCurl::add_debug_msg($matches[1].' | '.$matches[2].' | '.$matches[3]);
				} else {
						preg_match($regexpPrices3, $key[0], $matches);

						$matches[1] = 'https://www.eldorado.ru'.trim($matches[1]);
						$matches[2] = trim($matches[2]);

						price_change_detect($matches[1], $matches[2], '0', date("d.m.y-H:i:s"), $request->options[10004], $request->options[10006], $request->options[10018], ENGINE_CURR, ENGINE_TYPE);
						$itemsArray[trim($matches[1])] = array(
								$matches[2], 
								'0',
								date("d.m.y-H:i:s"),
								$request->options[10004],
								$request->options[10018],
								$request->url
						);
					AngryCurl::add_debug_msg($matches[1].' | '.$matches[2].' | 0');		
				}
			}
		file_put_contents(AC_DIR . DIRECTORY_SEPARATOR . 'engines' . DIRECTORY_SEPARATOR . ENGINE_CURR . DIRECTORY_SEPARATOR . 'data' . DIRECTORY_SEPARATOR . date("d.m.y") . '_' . ENGINE_CURR . '_' . ENGINE_TYPE . '_' . $region . '.data', serialize($itemsArray));
		//$itemsManual = array_unique($itemsManual);
		
		//die('К-во: '.$i);
		return 1;
	} else {
		echo 'bad response'.PHP_EOL;
		return 0;
		}
	}
}


function callback_one($response, $info, $request) {
  global $regexpP1;
  global $regexpP2;

  global $regexpPrices1;
  global $regexpPrices2;
  global $regexpPrices3;

  global $qOfPaginationPages;

  global $itemsArray;
  global $region;
	global $regexpRegion;
	global $regionRu;
	global $time_start;
	global $site_links;

	global $bad_urls;


	AngryCurl::add_debug_msg(PHP_EOL.$request->url);
	AngryCurl::add_debug_msg($info['http_code']);
	AngryCurl::add_debug_msg($request->options[10004]); 

  if ($info['http_code'] !== 200) {            
    $bad_urls[] = $request->url;
    if (round(microtime(1) - $time_start, 0) >= 240) $bad_urls=array();
  } else {
  	file_put_contents('/var/www/polaris/engines/eldorado.ru/content.txt', $response);

		preg_match($regexpRegion, $response, $region_name);
		//print_r($region_name);
		//$region_name[1] = trim(iconv("windows-1251", "UTF-8", $region_name[1]));
		echo 'request  region: '.$regionRu.PHP_EOL;
		echo 'response region: '.$region_name[1].PHP_EOL;	

		if (stripos($region_name[1], $regionRu) !== false) { // stripos(haystack, needle)

				preg_match($regexpP1, $response, $matches);
				//print_r($matches);
				preg_match_all($regexpP2, $matches[1], $matches2);
				//print_r($matches2);
				$temparrpage = array();
				foreach ($matches2[1] as $key => $value) {
					//echo "key: " . $key . "\n";
					echo "value:" . $value . "\n";
					if (is_numeric($value)) {
						$temparrpage[] = $value;
					}
				}

				if (@max($temparrpage) > $qOfPaginationPages) {
					$qOfPaginationPages = @max($temparrpage);	    	
				}
				echo 'Страниц: '.$qOfPaginationPages.PHP_EOL;


	  	preg_match_all($regexpPrices1, $response, $matches_items, PREG_SET_ORDER);
	  	//print_r($matches_items);


	  	foreach ($matches_items as $key) {
		  	if (strripos($key[0], 'Добавить в корзину') !== false) {
						preg_match($regexpPrices2, $key[0], $matches);
						//print_r($matches);

						$matches[1] = 'https://www.eldorado.ru'.trim($matches[1]);
						$matches[2] = trim($matches[2]);
						$matches[3] = preg_replace('~[^\d]+~', '' , $matches[3]);	

						if ($matches[1] && $matches[2]) {
							price_change_detect($matches[1], $matches[2], $matches[3], date("d.m.y-H:i:s"), $request->options[10004], $request->options[10006], $request->options[10018], ENGINE_CURR, ENGINE_TYPE);
							$itemsArray[trim($matches[1])] = array(
								$matches[2], 
								$matches[3],
								date("d.m.y-H:i:s"),
								$request->options[10004],
								$request->options[10018],
								$request->url
							);
						}
					AngryCurl::add_debug_msg($matches[1].' | '.$matches[2].' | '.$matches[3]);
				} else {
						preg_match($regexpPrices3, $key[0], $matches);

						$matches[1] = 'https://www.eldorado.ru'.trim($matches[1]);
						$matches[2] = trim($matches[2]);

						price_change_detect($matches[1], $matches[2], '0', date("d.m.y-H:i:s"), $request->options[10004], $request->options[10006], $request->options[10018], ENGINE_CURR, ENGINE_TYPE);
						$itemsArray[trim($matches[1])] = array(
								$matches[2], 
								'0',
								date("d.m.y-H:i:s"),
								$request->options[10004],
								$request->options[10018],
								$request->url
						);
					AngryCurl::add_debug_msg($matches[1].' | '.$matches[2].' | 0');		
				}
			}
		}	else {
			if ($info['http_code'] !== 404) {
		    $bad_urls[] = $request->url;
		    if (round(microtime(1) - $time_start, 0) >= 240) $bad_urls=array();
			}
		}
	}
}
