<?php
/**
 * kcentr.ru
 */
switch (EXTRA_PARAM) {
	case  'cheboksary':  
		$region = 'store[city]=Чебоксары;store[city_id]=2015;store[kladr]=21000001000;store[manual_select]=1;store[region]=dd8caeab-c685-4f2a-bf5f-550aca1bbc48';
 		$coockiecapt = 'Чебоксары;2015;21000001000;1;dd8caeab-c685-4f2a-bf5f-550aca1bbc48';
 		$city = 'Чебоксары';
 		break;
	case  'chelyabinsk':  
		$region = 'store[city]=Челябинск;store[city_id]=2197;store[kladr]=74000001000;store[manual_select]=1;store[region]=a376e68d-724a-4472-be7c-891bdb09ae32'; 
		$coockiecapt = 'Челябинск;2197;74000001000;1;a376e68d-724a-4472-be7c-891bdb09ae32';
		$city = 'Челябинск';
		break;	
	case  'habarovsk':  
		$region = 'store[city]=Хабаровск;store[city_id]=398;store[manual_select]=1;store[kladr]=27000001000;store[region]=a4859da8-9977-4b62-8436-4e1b98c5d13f'; 
		$coockiecapt = 'Хабаровск;398;1;27000001000;a4859da8-9977-4b62-8436-4e1b98c5d13f';
		$city = 'Хабаровск';
		break;	
	case  'kazan':
		$region = 'store[city]=Казань;store[city_id]=5068;store[kladr]=16000001000;store[manual_select]=1;store[region]=93b3df57-4c89-44df-ac42-96f05e9cd3b9'; 
		$coockiecapt = 'Казань;5068;16000001000;1;93b3df57-4c89-44df-ac42-96f05e9cd3b9';
		$city = 'Казань';
		break;
	case  'krasnodar':  
		$region = 'store[city]=Краснодар;store[city_id]=941;store[kladr]=23000001000;store[manual_select]=1;store[region]=7dfa745e-aa19-4688-b121-b655c11e482f'; 
		$coockiecapt = 'Краснодар;941;23000001000;1;7dfa745e-aa19-4688-b121-b655c11e482f';
		$city = 'Краснодар';
		break;	
	case  'krasnoyarsk':  
		$region = 'store[city]=Красноярск;store[city_id]=1447;store[kladr]=24000001000;store[manual_select]=1;store[region]=9b968c73-f4d4-4012-8da8-3dacd4d4c1bd'; 
		$coockiecapt = 'Красноярск;1447;24000001000;1;9b968c73-f4d4-4012-8da8-3dacd4d4c1bd';
		$city = 'Красноярск';
		break;		
	case  'moscow':  
		$region = 'store[city]=Москва;store[city_id]=1898;store[kladr]=77000000000;store[manual_select]=1;store[region]=0c5b2444-70a0-4932-980c-b4dc0d3f02b5'; 
		$coockiecapt = 'Москва;1898;77000000000;1;0c5b2444-70a0-4932-980c-b4dc0d3f02b5';
		$city = 'Москва';
		break;
 	case 'naberezhnye-chelny': 
 		$region = 'store[city]=Набережные Челны;store[city_id]=1610;store[kladr]=16000002000;store[manual_select]=1;store[region]=748d7afa-7407-4876-9f40-764ecdd09bbd'; 
 		$coockiecapt = 'Набережные Челны;1610;16000002000;1;748d7afa-7407-4876-9f40-764ecdd09bbd';
 		$city = 'Набережные Челны';
 		break;
	case  'novgorod':  
		$region = 'store[city]=%D0%9D%D0%B8%D0%B6%D0%BD%D0%B8%D0%B9+%D0%9D%D0%BE%D0%B2%D0%B3%D0%BE%D1%80%D0%BE%D0%B4;store[city_id]=2272;store[kladr]=52000001000;store[manual_select]=1;store[region]=555e7d61-d9a7-4ba6-9770-6caa8198c483'; 
		$coockiecapt = '%D0%9D%D0%B8%D0%B6%D0%BD%D0%B8%D0%B9+%D0%9D%D0%BE%D0%B2%D0%B3%D0%BE%D1%80%D0%BE%D0%B4;2272;52000001000;1;555e7d61-d9a7-4ba6-9770-6caa8198c483';
		$city = 'Нижний Новгород';
		break;		 
  case 'novosibirsk': 
  	$region = 'store[city]=Новосибирск;store[city_id]=1091;store[kladr]=54000001000;store[manual_select]=1;store[region]=8dea00e3-9aab-4d8e-887c-ef2aaa546456'; 
  	$coockiecapt = 'Новосибирск;1091;54000001000;1;8dea00e3-9aab-4d8e-887c-ef2aaa546456';
  	$city = 'Новосибирск';
  	break;	
	case  'omsk':  
		$region = 'store[city]=Омск;store[city_id]=2689;store[kladr]=55000001000;store[manual_select]=1;store[region]=140e31da-27bf-4519-9ea0-6185d681d44e'; 
		$coockiecapt = 'Омск;2689;55000001000;1;140e31da-27bf-4519-9ea0-6185d681d44e';
		$city = 'Омск';
		break;  	
	case  'petrozavodsk':  
		$region = 'store[city]=Петрозаводск;store[city_id]=5336;store[kladr]=10000001000;store[manual_select]=1;store[region]=ccc34487-8fd4-4e71-b032-f4e6c82fb354'; 
		$coockiecapt = 'Петрозаводск;5336;1;10000001000;ccc34487-8fd4-4e71-b032-f4e6c82fb354';
		$city = 'Петрозаводск';
		break;
 	case 'perm': 
 		$region = 'store[city]=Пермь;store[city_id]=2686;store[kladr]=59000001000;store[manual_select]=1;store[region]=a309e4ce-2f36-4106-b1ca-53e0f48a6d95'; 
 		$coockiecapt = 'Пермь;2686;59000001000;1;a309e4ce-2f36-4106-b1ca-53e0f48a6d95';
 		$city = 'Пермь';
 		break;
	case 'pyatigorsk':  
		$region = 'store[city]=Пятигорск;store[city_id]=3386;store[kladr]=26000007000;store[manual_select]=1;store[region]=9b0efbd0-22bb-400d-86db-ddc69b9939d9';
		$coockiecapt = 'Пятигорск;3386;26000007000;1;9b0efbd0-22bb-400d-86db-ddc69b9939d9';
		$city = 'Пятигорск';
		break;
	case 'rostov':
		$region = 'store[city]=Ростов-на-Дону;store[city_id]=3261;store[kladr]=61000001000;store[manual_select]=1;store[region]=c1cfe4b9-f7c2-423c-abfa-6ed1c05a15c5';
		$coockiecapt = 'Ростов-на-Дону;3261;61000001000;1;c1cfe4b9-f7c2-423c-abfa-6ed1c05a15c5';
		$city = 'Ростов-на-Дону';
		break;
  case 'samara': 
  	$region = 'store[city]=Самара;store[city_id]=1619;store[kladr]=63000001000;store[manual_select]=1;store[region]=bb035cc3-1dc2-4627-9d25-a1bf2d4b936b'; 
  	$coockiecapt = 'Самара;1619;63000001000;1;bb035cc3-1dc2-4627-9d25-a1bf2d4b936b';
  	$city = 'Самара';
  	break;
	case 'spb':  
		$region = 'store[city]=Санкт-Петербург;store[city_id]=2198;store[kladr]=78000000000;store[manual_select]=1;store[region]=c2deb16a-0330-4f05-821f-1d09c93331e6'; 
		$coockiecapt = 'Санкт-Петербург;2198;78000000000;1;c2deb16a-0330-4f05-821f-1d09c93331e6';
		$city = 'Санкт-Петербург';
		break;
 	case 'ufa': 
 		$region = 'store[city]=Уфа;store[city_id]=865;store[kladr]=02000001000;store[manual_select]=1;store[region]=7339e834-2cb4-4734-a4c7-1fca2c66e562'; 
 		$coockiecapt = 'Уфа;865;02000001000;1;7339e834-2cb4-4734-a4c7-1fca2c66e562';
 		$city = 'Уфа';
 		break;
	case 'vladivostok':  
		$region = 'store[city]=Владивосток;store[city_id]=4196;store[kladr]=25000001000;store[manual_select]=1;store[region]=7b6de6a5-86d0-4735-b11a-499081111af8'; 
		$coockiecapt = 'Владивосток;4196;25000001000;1;7b6de6a5-86d0-4735-b11a-499081111af8';
		$city = 'Владивосток';
		break;
	case 'volgograd':  
		$region = 'store[city]=Волгоград;store[city_id]=1837;store[kladr]=34000001000;store[manual_select]=1;store[region]=a52b7389-0cfe-46fb-ae15-298652a64cf8'; 
		$coockiecapt = 'Волгоград;1837;34000001000;1;a52b7389-0cfe-46fb-ae15-298652a64cf8';
		$city = 'Волгоград';
		break;	
 	case 'yekaterinburg': 
 		$region = 'store[city]=Екатеринбург;store[city_id]=1667;store[kladr]=66000001000;store[manual_select]=1;store[region]=2763c110-cb8b-416a-9dac-ad28a55b4402'; 
 		$coockiecapt = 'Екатеринбург;1667;66000001000;1;2763c110-cb8b-416a-9dac-ad28a55b4402';
 		$city = 'Екатеринбург';
 	default:
 		die("Unknown region\n");  	 		
}

$array_of_request_urls = array();
$options 			 = array(
								CURLOPT_COOKIE => $region,
								//CURLOPT_COOKIEJAR       => '/var/www/xxx/1.txt',
        				CURLOPT_COOKIEFILE      => '/var/www/polaris/engines/kcentr.ru/cookies/spb.txt',
                CURLOPT_CONNECTTIMEOUT => 20,
                CURLOPT_TIMEOUT        => 20,
                CURLOPT_AUTOREFERER     => TRUE,
                CURLOPT_FOLLOWLOCATION  => TRUE,
                CURLOPT_HEADER => true, 
                CURLOPT_SSL_VERIFYPEER => 0,
                CURLOPT_SSL_VERIFYHOST => 0
	);
$urlStart = 'https://' . ENGINE_CURR . '/search/?q=polaris&s=';
$urlEnd   = '&PAGEN_1=';
$regexpP1 = "~class=\"catalog-pagenav clearfix(.+)</div>~isU";
$regexpP2 = "~<a.*>(.+)<~isU";
$regexp1  = "~data-uuid=(.+)Status -->~isU";
$regexp2  = "~class=\"product-name.*href=\"(.+)\".*>(.+)<.*product-priceCurrent.*>(.+)</~isU";
$regexp3  = "~class=\"product-name.*href=\"(.+)\".*>(.+)<~isU";


if (ENGINE_LOOP == 13) {
	$regions = array('cheboksary', 'chelyabinsk', 'habarovsk', 'kazan', 'krasnodar', 'krasnoyarsk', 'moscow', 'naberezhnye-chelny', 'novgorod', 'novosibirsk', 'omsk', 'perm', 'rostov', 'spb', 'samara', 'ufa', 'volgograd', 'vladivostok', 'yekaterinburg');

	foreach ($regions as $region) {

		$content_file_path = '/var/www/polaris/engines/kcentr.ru/content/'.$region.'.txt';
		if (file_exists($content_file_path) && time() - filemtime($content_file_path) < 13600) {

			$itemsArray = array();

			$AC = new AngryCurl('callback_three');
			$AC->init_console();
			$response = file_get_contents($content_file_path);

			callback_three($response, $region, $content_file_path);

			file_put_contents(AC_DIR . DIRECTORY_SEPARATOR . 'engines' . DIRECTORY_SEPARATOR . ENGINE_CURR . DIRECTORY_SEPARATOR . 'data' . DIRECTORY_SEPARATOR . date("d.m.y") . '_' . ENGINE_CURR . '_' . ENGINE_TYPE . '_' . $region . '.data', serialize($itemsArray));
		} else {
			echo 'Старый файл: '.$content_file_path.PHP_EOL;
		}
	}

	$filename = AC_DIR . DIRECTORY_SEPARATOR . 'reports' . DIRECTORY_SEPARATOR . ENGINE_CURR . '_' . ENGINE_TYPE . '_' . EXTRA_PARAM . '.csv';

} else {

	// Загрузка отсканированных ссылок:
	foreach ($itemsArray as $key => $value) {
		$date = DateTime::createFromFormat('d.m.y-H:i:s', $value[2]);
		//echo (time() - $date->format('U')).PHP_EOL; 
		if (time() - $date->format('U') <= 3800) {
			$already_scanned[] = trim($value[5]);
		}
		
	}
	if ($already_scanned) {
		$already_scanned = array_unique($already_scanned);
		$already_scanned = array_values($already_scanned);
		print_r($already_scanned); 
	} else {
		$already_scanned = array();
	}





	$directLinks = explode("\n", file_get_contents('/var/www/polaris/engines/'.ENGINE_CURR.'/'.ENGINE_TYPE.'.txt'));
	array_walk($directLinks, 'trim_value');
	print_r($directLinks);


	foreach ($directLinks as $url) {
		if (!in_array($url, $already_scanned)) {
			$i = 1;
			echo 'сканирую адрес:'.PHP_EOL.$url.PHP_EOL;
			while ( regular_one($url)<1 && $i<5 ) {
				$i++;
			}
		} else {
			echo 'уже сканировал:'.PHP_EOL.$url.PHP_EOL;
		}
	}


	file_put_contents(AC_DIR . DIRECTORY_SEPARATOR . 'engines' . DIRECTORY_SEPARATOR . ENGINE_CURR . DIRECTORY_SEPARATOR . 'data' . DIRECTORY_SEPARATOR . date("d.m.y") . '_' . ENGINE_CURR . '_' . ENGINE_TYPE . '_' . EXTRA_PARAM . '.data', serialize($itemsArray));
	$filename = AC_DIR . DIRECTORY_SEPARATOR . 'reports' . DIRECTORY_SEPARATOR . ENGINE_CURR . '_' . ENGINE_TYPE . '_' . EXTRA_PARAM . '.csv';
}

/** 
 *              Callback Functions           
 */

function callback_three($response, $region, $content_file_path) {
  global $regexpP1;
  global $regexpP2;
	global $regexp1;
	global $regexp2;
	global $regexp3;
	global $itemsArray;
	global $errorsArray;
  global $qOfPaginationPages;  
  global $bad_urls;
  global $time_start;
  global $city;
  global $coockiecapt;
  global $array_of_request_urls;
  global $region;

	AngryCurl::add_debug_msg(PHP_EOL.$request->url);
	AngryCurl::add_debug_msg($info['http_code']);
	AngryCurl::add_debug_msg($request->options[10004]);

  if ($response) {
  	//file_put_contents('/var/www/polaris/engines/kcentr.ru/content.txt', $response);
  	
  	preg_match("~data-target=\"#modalCity\">(.+)</button~isU", $response, $mReg);
  	//print_r($mReg);
  	$mReg[1] = trim(strip_tags($mReg[1]));
  	echo 'Регион: '.$mReg[1].' - '.$city.PHP_EOL;
  	if (1 ==1 ) {//trim($mReg[1]) == $city
			@preg_match($regexpP1, $response, $matches);
			//print_r($matches);
			@preg_match_all($regexpP2, $matches[1], $matches2);
			//print_r($matches2);
			$temparrpage = array();
			foreach ($matches2[1] as $key => $value) {
				//echo "key: " . $key . "\n";
				echo "value:" . $value . "\n";
				if (is_numeric($value)) {
					$temparrpage[] = $value;
				}
			}

			if (@max($temparrpage) > $qOfPaginationPages) {
				//echo "Страницы: " . $temparrpage . "\n";
				$qOfPaginationPages = @max($temparrpage);	    	
			}		

	  	preg_match_all($regexp1, $response, $matches2, PREG_SET_ORDER); //
	  	//print_r($matches2);
	  	foreach ($matches2 as $key) {  		
				@preg_match($regexp2, $key[1], $matches);
				//print_r($matches);
				if (@$matches[2] && @$matches[2]) {
					# code...
				
					if (strripos($key[1], 'product-priceCurrent') !== false) {
						price_change_detect('https://' . ENGINE_CURR . trim($matches[1]), trim($matches[2]), preg_replace('~[^\d]+~', '' ,$matches[3]), date("d.m.y-H:i:s"), $request->options[10004], $request->options[10006], $request->options[10018], ENGINE_CURR, ENGINE_TYPE);
						$itemsArray['https://' . ENGINE_CURR . trim($matches[1])] = array(
							trim($matches[2]), 
							trim(preg_replace('~[^\d]+~', '' ,$matches[3])),
							date("d.m.y-H:i:s", filectime($content_file_path)),
							$request->options[10004],
							$request->options[10018],
							$request->url
						);		
						echo trim($matches[2]).' | '.preg_replace('~[^\d]+~', '' ,$matches[3]).PHP_EOL;

						

					} else {
						@preg_match($regexp3, $key[1], $matches);
						if (@$matches[2] && @$matches[2]) {
							price_change_detect('https://' . ENGINE_CURR . trim($matches[1]), trim($matches[2]), '0', date("d.m.y-H:i:s"), $request->options[10004], $request->options[10006], $request->options[10018], ENGINE_CURR, ENGINE_TYPE);
							$itemsArray['https://' . ENGINE_CURR . trim($matches[1])] = array(
								trim($matches[2]), 
								'0',
								date("d.m.y-H:i:s", filectime($content_file_path)),
								$request->options[10004],
								$request->options[10018],
								$request->url
							);		
							echo trim($matches[2]).' | 0'.PHP_EOL;
						}				
					}
				
				} else {
					@preg_match($regexp3, $key[1], $matches);
					if (@$matches[2] && @$matches[2]) {
						price_change_detect('https://' . ENGINE_CURR . trim($matches[1]), trim($matches[2]), '0', date("d.m.y-H:i:s"), $request->options[10004], $request->options[10006], $request->options[10018], ENGINE_CURR, ENGINE_TYPE);
						$itemsArray['https://' . ENGINE_CURR . trim($matches[1])] = array(
							trim($matches[2]), 
							'0',
							date("d.m.y-H:i:s", filectime($content_file_path)),
							$request->options[10004],
							$request->options[10018],
							$request->url
						);		
						echo trim($matches[2]).' | 0'.PHP_EOL;
					}
				}					  		
			}
			file_put_contents(AC_DIR . DIRECTORY_SEPARATOR . 'engines' . DIRECTORY_SEPARATOR . ENGINE_CURR . DIRECTORY_SEPARATOR . 'data' . DIRECTORY_SEPARATOR . date("d.m.y") . '_' . ENGINE_CURR . '_' . ENGINE_TYPE . '_' . $region . '.data', serialize($itemsArray));
	  } else {
	    $bad_urls[] = $request->url;
	  	/**
	  	 * Выходим, если прошло слишком много времени
	  	 */  	
			if (round(microtime(1) - $time_start, 0) >= 180) { $bad_urls = array(); } 	  	
	  }
  }
}






