<?php
/**
 * techport.ru
 */
switch (EXTRA_PARAM) {
case 'abakan':          $region =  '1900000100000'; break;
case 'almetevsk':          $region =  '1600800100000'; break;
case 'anapa':          $region =  '2300300100000'; break;
case 'angarsk':          $region =  '3800000400000'; break;
case 'apatity':          $region =  '5100000200000'; break;
case 'arzamas':          $region =  '5200000400000'; break;
case 'armavir':          $region =  '2300000200000'; break;
case 'arhangelsk':          $region =  '2900000100000'; break;
case 'astrakhan':          $region =  '3000000100000'; break;
case 'achinsk':          $region =  '2400001200000'; break;
case 'balakovo':          $region =  '6400000400000'; break;
case 'barnaul':          $region =  '2200000100000'; break;
case 'belgorod':          $region =  '3100000100000'; break;
case 'berezniki':          $region =  '5900000200000'; break;
case 'biysk':          $region =  '3200000100000'; break;
case 'blagoveschensk':          $region =  '0201500100000'; break;
case 'borisoglebsk':          $region =  '3600500100000'; break;
case 'bratsk':          $region =  '3800000500000'; break;
case 'bryansk':          $region =  '3200000100000'; break;
case 'velikijnovgorod':          $region =  '5300000100000'; break;
case 'vladikavkaz':          $region =  '1500000100000'; break;
case 'vladimir':          $region =  '3300000100000'; break;
case 'volgograd':          $region =  '3400000100000'; break;
case 'volgodonsk':          $region =  '6100000400000'; break;
case 'volzhskij':          $region =  '3400000200000'; break;
case 'vologda':          $region =  '3500000100000'; break;
case 'voronezh':          $region =  '3600000100000'; break;
case 'gubkin':          $region =  '3100000400000'; break;
case 'derbent':          $region =  '0500000600000'; break;
case 'dimitrovgrad':          $region =  '7300000200000'; break;
case 'yekaterinburg':          $region =  '6600000100000'; break;
case 'essentuki':          $region =  '2600000200000'; break;
case 'zheleznogorsk':          $region =  '2400000400000'; break;
case 'ivanovo':          $region =  '3700000100000'; break;
case 'izhevsk':          $region =  '1800000100000'; break;
case 'irkutsk':          $region =  '3800000300000'; break;
case 'joshkar-ola':          $region =  '1200000100000'; break;
case 'kazan':          $region =  '1600000100000'; break;
case 'kaliningrad':          $region =  '3900000100000'; break;
case 'kaluga':          $region =  '4000000100000'; break;
case 'kamyshin':          $region =  '3400000300000'; break;
case 'kasimov':          $region =  '6200000400000'; break;
case 'kemerovo':          $region =  '4200000900000'; break;
case 'kirov':          $region =  '4300000100000'; break;
case 'kislovodsk':          $region =  '2600000400000'; break;
case 'kostroma':          $region =  '4400000300000'; break;
case 'krasnoturinsk':          $region =  '6600001000000'; break;
case 'krasnoyarsk':          $region =  '2400000100000'; break;
case 'krasnodar':          $region =  '2300000100000'; break;
case 'kropotkin':          $region =  '2301200100000'; break;
case 'kurgan':          $region =  '4500000100000'; break;
case 'kursk':          $region =  '4600000100000'; break;
case 'lipeck':          $region =  '4800000100000'; break;
case 'lyantor':          $region =  '8600900200000'; break;
case 'magnitogorsk':          $region =  '7400000900000'; break;
case 'majkop':          $region =  '0100000100000'; break;
case 'mahachkala':          $region =  '0500000100000'; break;
case 'miass':          $region =  '7400001000000'; break;
case 'mineralnye-vody':          $region =  '2601700200000'; break;
case 'murmansk':          $region =  '5100000100000'; break;
case 'naberezhnye-chelny':          $region =  '1600000200000'; break;
case 'nadym':          $region =  '8900000500000'; break;
case 'nalchik':          $region =  '0700000100000'; break;
case 'nevinnomyssk':          $region =  '2600000600000'; break;
case 'neftekamsk':          $region =  '0200000300000'; break;
case 'nefteyugansk':          $region =  '8600001400000'; break;
case 'nizhnevartovsk':          $region =  '8600001100000'; break;
case 'nizhnekamsk':          $region =  '1603100100000'; break;
case 'novokuzneck':          $region =  '4200001200000'; break;
case 'novorossijsk':          $region =  '2300000600000'; break;
case 'novosibirsk':          $region =  '5400000100000'; break;
case 'novotroick':          $region =  '5600000300000'; break;
case 'novocherkassk':          $region =  '6100000900000'; break;
case 'novyj-urengoj':          $region =  '8900000600000'; break;
case 'noyabrsk':          $region =  '8900000700000'; break;
case 'nyagan':          $region =  '8600000500000'; break;
case 'obninsk':          $region =  '4000000200000'; break;
case 'oktyabrskij':          $region =  '0200000400000'; break;
case 'omsk':          $region =  '5500000100000'; break;
case 'orel':          $region =  '5700000100000'; break;
case 'orenburg':          $region =  '5600000100000'; break;
case 'pavlovo':          $region =  '5203200100000'; break;
case 'penza':          $region =  '5800000100000'; break;
case 'pervouralsk':          $region =  '6600001600000'; break;
case 'petrozavodsk':          $region =  '1000000100000'; break;
case 'pskov':          $region =  '6000000100000'; break;
case 'pyatigorsk':          $region =  '2600000700000'; break;
case 'revda':          $region =  '6600001800000'; break;
case 'rybinsk':          $region =  '7601500100000'; break;
case 'ryazan':          $region =  '6200000100000'; break;
case 'salavat':          $region =  '0200000500000'; break;
case 'samara':          $region =  '6300000100000'; break;
case 'saransk':          $region =  '1300000100000'; break;
case 'saratov':          $region =  '6400000100000'; break;
case 'sarov':          $region =  '5200000300000'; break;
case 'severodvinsk':          $region =  '2900000400000'; break;
case 'seversk':          $region =  '7000000300000'; break;
case 'smolensk':          $region =  '6700000300000'; break;
case 'solnechnogorsk':          $region =  '5003300100000'; break;
case 'sochi':          $region =  '2300000700000'; break;
case 'stavropol':          $region =  '2600000100000'; break;
case 'staryj-oskol':          $region =  '3100000200000'; break;
case 'sterlitamak':          $region =  '0200001400000'; break;
case 'stupino':          $region =  '5003400100000'; break;
case 'surgut':          $region =  '8600001000000'; break;
case 'syzran':          $region =  '6300000800000'; break;
case 'syktyvkar':          $region =  '1100000100000'; break;
case 'taganrog':          $region =  '6100001100000'; break;
case 'tambov':          $region =  '6800000400000'; break;
case 'tver':          $region =  '6900000100000'; break;
case 'tobolsk':          $region =  '7200000200000'; break;
case 'tolyatti':          $region =  '6300000700000'; break;
case 'tomsk':          $region =  '7000000100000'; break;
case 'tuapse':          $region =  '2303600100000'; break;
case 'tula':          $region =  '7100000100000'; break;
case 'tyumen':          $region =  '7200000100000'; break;
case 'ulan-udeh':          $region =  '0300000100000'; break;
case 'ulyanovsk':          $region =  '7300000100000'; break;
case 'uhta':          $region =  '1100000800000'; break;
case 'habarovsk':          $region =  '2700000100000'; break;
case 'hanty-mansijsk':          $region =  '8600000100000'; break;
case 'cheboksary':          $region =  '2100000100000'; break;
case 'chelyabinsk':          $region =  '7400000100000'; break;
case 'cherepovec':          $region =  '3500000200000'; break;
case 'cherkessk':          $region =  '0900000100000'; break;
case 'chita':          $region =  '7500000100000'; break;
case 'shahty':          $region =  '6100001200000'; break;
case 'ehngels':          $region =  '6400001300000'; break;
case 'yugorsk':          $region =  '8600001600000'; break;
case 'yakutsk':          $region =  '1400000100000'; break;
case 'yaroslavl':          $region =  '7600000100000'; break;

// Города-Миллионики
  case 'moscow': 
  	$region = 'MSK';
    break;
  case 'omsk': 
  	$region = '2300000100000';
    break;
  case 'novgorod':
  	$region = 'NNV_10';
    break;
  case 'perm':
  	$region = 'PRM_25';
    break;
  case 'rostov':
  	$region = '6100000100000';
    break;
  case 'spb':
    $region = 'SPB_2';
    break;      
  case 'ufa':
  	$region = '0200000100000';
    break;
  case 'vladivostok':
  	$region = '2500000100000';
    break;
 	default:
 		die("Unknown region\n"); 		
}

$options 			 = array(
	CURLOPT_COOKIE => 'nusc=' . $region, 
	CURLOPT_ENCODING => "",
	CURLOPT_CONNECTTIMEOUT => 20,
	CURLOPT_TIMEOUT        => 240,
	CURLOPT_AUTOREFERER     => TRUE,
	CURLOPT_FOLLOWLOCATION  => TRUE,
	CURLOPT_HEADER => true, 
	CURLOPT_SSL_VERIFYPEER => 0	

	); 	// Подставляем coockie региона
$urlStart 		 = 'https://www.techport.ru/q/?t=' . ENGINE_TYPE . '&offset=';		// Первая часть адреса
$regexpP 			 = "~tcp-pagination_visible-xs\">(.+)<span~isU";	// Пагинация
//$regexpP2 		 = "~</div><div class=\"tcp-pagination__item\">.*href=.*role=\"button\">(.+)</a>~isU";
$regexpP2 		 = "~href=.*>(.+)</a>~isU";	
//$regexpPrices  = "~tcp-product_small\">(.+)class=\"tcp-product-actions\">~isU"; 			// Все товары на странице
//$regexpPrices2 = "~class=\"tcp-product-body\".*href=\"(.+)\".*>(.+)</.*class=\"tcp-product-body__new-price\">(.+)<~isU";
$regexpPrices  = "~tcp-product_vertical-tile(.+)tcp-product-actions__right~isU"; 			// Все товары на странице
$regexpPrices2 = "~list-item.*href=\"(.+)\".*>(.+)</.*class=\"tcp-product-body__new-price\">(.+)<~isU";
$regexpPrices3 = "~list-item.*href=\"(.+)\".*>(.+)</~isU";

// Загрузка отсканированных ссылок:

foreach ($itemsArray as $key => $value) {
	$date = DateTime::createFromFormat('d.m.y-H:i:s', $value[2]);
	//echo (time() - $date->format('U')).PHP_EOL; 
	if (time() - $date->format('U') <= 1800) {
		$already_scanned[] = $value[5];
	}
	
}
if ($already_scanned) {
	$already_scanned = array_unique($already_scanned);
	$already_scanned = array_values($already_scanned);
	//print_r($already_scanned); 
} else {
	$already_scanned = array();
}
//$already_scanned = array();

	// Узнаем, сколько позиций в пагинации
	$AC->get($urlStart . '0', NULL, $options);
	//$AC->get('https://www.techport.ru/q/?t=polaris&offset=196', NULL, $options);
	//$AC->get($urlStart . '56', NULL, $options);
	//$AC->get($urlStart . '84', NULL, $options);
	$AC->execute(4);	

	while ($bad_urls) {      // Перебираем заново адреса, не вернувшие контент
	  $AC->flush_requests(); // Чистим массив запросов
	  foreach ($bad_urls as $urls) { // Готовим новый цикл из битых URLs
	    $AC->get($urls, NULL, $options);       
	  }
	  unset($urls);
	  $bad_urls = array();    // Чистим массив URL-ов для следующего (возможного) цикла    
	  $AC->execute(WINDOW_SIZE);       // Запускаем цикл, пока последний адрес не вернёт контент. Нужно придумать условия выхода!!!!!
	}
	unset($urls);



//$qOfPaginationPages = 8;

	if ($qOfPaginationPages) {
		echo 'Количество страниц: ' . $qOfPaginationPages . "\n";
			// Наименования товара и цены
		$AC->flush_requests();
		$AC->__set('callback','callback_two');	

		$is_any = 0;
		for ($i = 1; $i < $qOfPaginationPages; $i++) {
			if (!in_array($urlStart . $i*28, $already_scanned)) {
				echo 'сканирую адрес:'.PHP_EOL.$urlStart.($i*28).PHP_EOL;
				$AC->get($urlStart . $i*28, NULL, $options);
				$is_any = 1;
			} else {
				echo 'уже сканировал:'.PHP_EOL.$urlStart . ($i*28).PHP_EOL;
			}
		}

		if ($is_any) {
			$AC->execute(WINDOW_SIZE);
		}
		

		while ($bad_urls) {      // Перебираем заново адреса, не вернувшие контент
		  $AC->flush_requests(); // Чистим массив запросов
		  foreach ($bad_urls as $urls) { // Готовим новый цикл из битых URLs
		    $AC->get($urls, NULL, $options);      
		  }
		  unset($urls);
		  $bad_urls = array();    // Чистим массив URL-ов для следующего (возможного) цикла    
		  $AC->execute(WINDOW_SIZE);       // Запускаем цикл, пока последний адрес не вернёт контент. Нужно придумать условия выхода!!!!!
		}
		unset($urls);
	}
		// Сохраним массив в переменную
	file_put_contents(AC_DIR . DIRECTORY_SEPARATOR . 'engines' . DIRECTORY_SEPARATOR . ENGINE_CURR . DIRECTORY_SEPARATOR . 'data' . DIRECTORY_SEPARATOR . date("d.m.y") . '_' . ENGINE_CURR . '_' . ENGINE_TYPE . '_' . EXTRA_PARAM . '.data', serialize($itemsArray));	
	$filename = AC_DIR . DIRECTORY_SEPARATOR . 'reports' . DIRECTORY_SEPARATOR . ENGINE_CURR . '_' . ENGINE_TYPE . '_' . EXTRA_PARAM . '.csv';


/** 
 *              Callback Functions           
 */
function callback_one($response, $info, $request) {
  global $regexpP;
  global $regexpP2;
  global $qOfPaginationPages;
  global $bad_urls;
	global $regexpPrices;
	global $regexpPrices2;
	global $itemsArray;
	global $time_start;
	global $errorsArray;

	AngryCurl::add_debug_msg(PHP_EOL.$request->url);
	AngryCurl::add_debug_msg($info['http_code']);
	AngryCurl::add_debug_msg($request->options[10004]);

	file_put_contents("/var/www/polaris/engines/techport.ru/content.txt", $response);

  if ($info['http_code'] !== 200) {                
    $bad_urls[] = $request->url;
    if (round(microtime(1) - $time_start, 0) >= 60) { $bad_urls = array(); }    
  } else {
  	
  	preg_match("~tcp-current-city__select.*>(.+)<~isU", $response, $mregion);
  	$mregion[1] = trim($mregion[1]);
  	echo 'Регион: '.$mregion[1].' | '.EXTRA_PARAM.PHP_EOL;


		preg_match($regexpP, $response, $matches);
		preg_match_all($regexpP2, $matches[1], $matches2);
		//print_r($matches2);
		$temparrpage = array();
		foreach ($matches2[1] as $key => $value) {
			//echo "key: " . $key . "\n";
			echo "value:" . $value . "\n";
			if (is_numeric($value)) {
				$temparrpage[] = $value;
			}
		}

		if (@max($temparrpage) > $qOfPaginationPages) {
			$qOfPaginationPages = @max($temparrpage);		    	
		}

	  	preg_match_all($regexpPrices, $response, $matches2, PREG_SET_ORDER); // Режем все карточки на странице	  	
	  	//print_r($matches2);
	  	foreach ($matches2 as $key) {
				preg_match($regexpPrices2, $key[1], $matches);
				//print_r($matches);
				if ($matches[1] && strripos($key[1], 'В наличии') !== false) {
					//$matches = parser_clean($matches, 2, 3);
					$matches[2] = str_replace('&nbsp;', ' ', $matches[2]);
					price_change_detect('http://' . ENGINE_CURR . trim($matches[1]), str_replace('<br>', ' ', $matches[2]), preg_replace('~[^\d.]+~', '', $matches[3]), date("d.m.y-H:i:s"), $request->options[10004], $request->options[10006], $request->options[10018], ENGINE_CURR, ENGINE_TYPE);
					$itemsArray['http://' . ENGINE_CURR . trim($matches[1])] = array(str_replace('<br>', ' ', $matches[2]), preg_replace('~[^\d.]+~', '', $matches[3]), date("d.m.y-H:i:s"), $request->options[10004], $request->options[10018], $request->url);
					AngryCurl::add_debug_msg($matches[1].' | '.$matches[2].' | '.preg_replace('~[^\d.]+~', '', $matches[3]));
				} else {
					if ($matches[1] && $matches[2]) {
						//$matches = parser_clean($matches, 2, 3);
						$matches[2] = str_replace('&nbsp;', ' ', $matches[2]);
						price_change_detect('http://' . ENGINE_CURR . trim($matches[1]), str_replace('<br>', ' ', $matches[2]), '0', date("d.m.y-H:i:s"), $request->options[10004], $request->options[10006], $request->options[10018], ENGINE_CURR, ENGINE_TYPE);
						$itemsArray['http://' . ENGINE_CURR . trim($matches[1])] = array(str_replace('<br>', ' ', $matches[2]), '0', date("d.m.y-H:i:s"), $request->options[10004], $request->options[10018], $request->url);
						AngryCurl::add_debug_msg($matches[1].' | '.$matches[2].' | 0');
					}
				}
			}

  }
}

function callback_two($response, $info, $request) {
	global $regexpPrices;
	global $regexpPrices2;
	global $regexpPrices3;
	global $itemsArray;
	global $bad_urls;
	global $time_start;
	global $errorsArray;

	AngryCurl::add_debug_msg(PHP_EOL.$request->url);
	AngryCurl::add_debug_msg($info['http_code']);
	AngryCurl::add_debug_msg($request->options[10004]);

  if ($info['http_code'] !== 200) {
    $bad_urls[] = $request->url;
  	/**
  	 * Выходим, если прошло слишком много времени
  	 */  	  	
		if (round(microtime(1) - $time_start, 0) >= 120) { $bad_urls = array(); }    
  } else {  	
	  	preg_match_all($regexpPrices, $response, $matches2, PREG_SET_ORDER); // Режем все карточки на странице	  	
	  	//print_r($matches2);
	  	foreach ($matches2 as $key) {
				preg_match($regexpPrices2, $key[1], $matches);
				//print_r($matches);
				if ($matches[1] && strripos($key[1], 'В наличии') !== false) {
					//$matches = parser_clean($matches, 2, 3);
					$matches[2] = str_replace('&nbsp;', ' ', $matches[2]);
					price_change_detect('http://' . ENGINE_CURR . trim($matches[1]), str_replace('<br>', ' ', $matches[2]), preg_replace('~[^\d.]+~', '', $matches[3]), date("d.m.y-H:i:s"), $request->options[10004], $request->options[10006], $request->options[10018], ENGINE_CURR, ENGINE_TYPE);
					$itemsArray['http://' . ENGINE_CURR . trim($matches[1])] = array(str_replace('<br>', ' ', $matches[2]), preg_replace('~[^\d.]+~', '', $matches[3]), date("d.m.y-H:i:s"), $request->options[10004], $request->options[10018], $request->url);
					AngryCurl::add_debug_msg($matches[1].' | '.$matches[2].' | '.preg_replace('~[^\d.]+~', '', $matches[3]));
				} else {
					preg_match($regexpPrices3, $key[1], $matches);
					if ($matches[1] && $matches[2]) {
						
						$matches[2] = str_replace('&nbsp;', ' ', $matches[2]);
						price_change_detect('http://' . ENGINE_CURR . trim($matches[1]), str_replace('<br>', ' ', $matches[2]), '0', date("d.m.y-H:i:s"), $request->options[10004], $request->options[10006], $request->options[10018], ENGINE_CURR, ENGINE_TYPE);
						$itemsArray['http://' . ENGINE_CURR . trim($matches[1])] = array(str_replace('<br>', ' ', $matches[2]), '0', date("d.m.y-H:i:s"), $request->options[10004], $request->options[10018], $request->url);
						AngryCurl::add_debug_msg($matches[1].' | '.$matches[2].' | 0');
					}
				}
			}
  }
}
