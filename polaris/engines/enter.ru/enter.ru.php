<?php
/**
 * enter.ru
 */
switch (EXTRA_PARAM) {
	case	'abakan': $region = '124221'; break;	//	Абакан
	case	'almetevsk': $region = '126757'; break;	//	Альметьевск
	case	'anapa': $region = '122578'; break;	//	Анапа
	case	'apatity': $region = '144784'; break;	//	Апатиты
	case	'armavir': $region = '122252'; break;	//	Армавир
	case	'arhangelsk': $region = '152594'; break;	//	Архангельск
	case	'astrakhan': $region = '124222'; break;	//	Астрахань
	case	'achinsk': $region = '144829'; break;	//	Ачинск
	case	'balakovo': $region = '124371'; break;	//	Балаково
	case	'barnaul': $region = '152590'; break;	//	Барнаул
	case	'belgorod': $region = '13241'; break;	//	Белгород
	case	'berezniki': $region = '144885'; break;	//	Березники
	case	'biysk': $region = '143719'; break;	//	Бийск
	case	'blagoveschensk': $region = '124203'; break;	//	Благовещенск
	case	'bratsk': $region = '126761'; break;	//	Братск
	case	'bryansk': $region = '83210'; break;	//	Брянск
	case	'velikijnovgorod': $region = '78637'; break;	//	Великий Новгород
	case	'vladivostok': $region = '124206'; break;	//	Владивосток
	case	'vladimir': $region = '96423'; break;	//	Владимир
	case	'volgograd': $region = '143707'; break;	//	Волгоград
	case	'volgodonsk': $region = '153933'; break;	//	Волгодонск
	case	'volzhskij': $region = '150993'; break;	//	Волжский
	case	'vologda': $region = '152595'; break;	//	Вологда
	case	'voronezh': $region = '18074'; break;	//	Воронеж
	case	'dimitrovgrad': $region = '144987'; break;	//	Димитровград
	case	'yekaterinburg': $region = '93751'; break;	//	Екатеринбург
	case	'ivanovo': $region = '93747'; break;	//	Иваново
	case	'izhevsk': $region = '124230'; break;	//	Ижевск
	case	'irkutsk': $region = '152596'; break;	//	Иркутск
	case	'joshkar-ola': $region = '124224'; break;	//	Йошкар-Ола
	case	'kazan': $region = '124229'; break;	//	Казань
	case	'kaluga': $region = '148110'; break;	//	Калуга
	case	'kamyshin': $region = '153838'; break;	//	Камышин
	case	'kemerovo': $region = '152585'; break;	//	Кемерово
	case	'kirov': $region = '124223'; break;	//	Киров
	case	'kostroma': $region = '126747'; break;	//	Кострома
	case	'krasnodar': $region = '124190'; break;	//	Краснодар
	case	'krasnoturinsk': $region = '145003'; break;	//	Краснотурьинск
	case	'krasnoyarsk': $region = '152599'; break;	//	Красноярск
	case	'kropotkin': $region = '122923'; break;	//	Кропоткин
	case	'kurgan': $region = '152597'; break;	//	Курган
	case	'kursk': $region = '74562'; break;	//	Курск
	case	'lipeck': $region = '99'; break;	//	Липецк
	case	'lyantor': $region = '146053'; break;	//	Лянтор
	case	'magnitogorsk': $region = '126765'; break;	//	Магнитогорск
	case	'majkop': $region = '143686'; break;	//	Майкоп
	case	'miass': $region = '145058'; break;	//	Миасс
	case	'mineralnye-vody': $region = '153984'; break;	//	Минеральные Воды
	case	'moscow': $region = '14974'; break;	//	Москва
	//case	'murmansk': $region = '124215'; break;	//	Мурманск
	case	'naberezhnye-chelny': $region = '152584'; break;	//	Набережные Челны
	case	'nadym': $region = '154002'; break;	//	Надым
	case	'nevinnomyssk': $region = '153981'; break;	//	Невинномысск
	case	'nefteyugansk': $region = '146054'; break;	//	Нефтеюганск
	case	'nizhnevartovsk': $region = '124242'; break;	//	Нижневартовск
	case	'nizhnekamsk': $region = '126759'; break;	//	Нижнекамск
	case	'novgorod': $region = '99958'; break;	//	Нижний Новгород
	case	'nizhnij-tagil': $region = '148122'; break;	//	Нижний Тагил
	case	'novokuzneck': $region = '124235'; break;	//	Новокузнецк
	case	'novorossijsk': $region = '122363'; break;	//	Новороссийск
	case	'novosibirsk': $region = '93750'; break;	//	Новосибирск
	case	'novotroick': $region = '144835'; break;	//	Новотроицк
	case	'novocherkassk': $region = '119487'; break;	//	Новочеркасск
	case	'novyj-urengoj': $region = '124243'; break;	//	Новый Уренгой
	case	'noyabrsk': $region = '145074'; break;	//	Ноябрьск
	case	'nyagan': $region = '153998'; break;	//	Нягань
	case	'obninsk': $region = '152577'; break;	//	Обнинск
	case	'omsk': $region = '152593'; break;	//	Омск
	case	'orel': $region = '13242'; break;	//	Орел
	case	'orenburg': $region = '124226'; break;	//	Оренбург
	case	'orsk': $region = '144834'; break;	//	Орск
	case	'penza': $region = '124227'; break;	//	Пенза
	case	'pervouralsk': $region = '145014'; break;	//	Первоуральск
	case	'perm': $region = '124228'; break;	//	Пермь
	case	'petrozavodsk': $region = '124213'; break;	//	Петрозаводск
	case	'pskov': $region = '124216'; break;	//	Псков
	case	'pyatigorsk': $region = '153982'; break;	//	Пятигорск
	case	'revda': $region = '148120'; break;	//	Ревда
	case	'rostov': $region = '119623'; break;	//	Ростов-на-Дону
	case	'rybinsk': $region = '113724'; break;	//	Рыбинск
	case	'ryazan': $region = '10374'; break;	//	Рязань
	case	'salavat': $region = '153466'; break;	//	Салават
	case	'samara': $region = '93749'; break;	//	Самара
	case	'spb': $region = '108136'; break;	//	Санкт-Петербург
	case	'saratov': $region = '124201'; break;	//	Саратов
	case	'sarov': $region = '153814'; break;	//	Саров
	case	'severodvinsk': $region = '143714'; break;	//	Северодвинск
	case	'seversk': $region = '144991'; break;	//	Северск
	case	'smolensk': $region = '88434'; break;	// Смоленск
	case	'sochi': $region = '122391'; break;	//	Сочи
	case	'stavropol': $region = '124217'; break;	//	Ставрополь
	//case	'staryj-oskol': $region = '153812'; break;	//	Старый Оскол
	case	'sterlitamak': $region = '153462'; break;	//	Стерлитамак
	case	'surgut': $region = '124241'; break;	//	Сургут
	case	'syktyvkar': $region = '124214'; break;	//	Сыктывкар
	case	'taganrog': $region = '119790'; break;	//	Таганрог
	case	'tambov': $region = '83209'; break;	//	Тамбов
	case	'tver': $region = '18073'; break;	//	Тверь
	case	'tobolsk': $region = '145034'; break;	//	Тобольск
	case	'tolyatti': $region = '126766'; break;	//	Тольятти
	case	'tomsk': $region = '124238'; break;	//	Томск
	case	'tuapse': $region = '124023'; break;	//	Туапсе
	case	'tula': $region = '74358'; break;	//	Тула
	case	'tyumen': $region = '152586'; break;	//	Тюмень
	case	'ulan-udeh': $region = '152598'; break;	//	Улан-Удэ
	case	'ulyanovsk': $region = '124231'; break;	//	Ульяновск
	case	'ufa': $region = '93748'; break;	//	Уфа
	case	'uhta': $region = '144779'; break;	//	Ухта
	case	'habarovsk': $region = '124209'; break;	//	Хабаровск
	case	'hanty-mansijsk': $region = '126764'; break;	//	Ханты-Мансийск
	case	'cheboksary': $region = '124232'; break;	//	Чебоксары
	//case	'chelyabinsk': $region = '93752'; break;	//	Челябинск
	case	'cherepovec': $region = '126760'; break;	//	Череповец
	case	'chita': $region = '124220'; break;	//	Чита
	case	'shahty': $region = '119842'; break;	//	Шахты
	//case	'ehngels': $region = '126722'; break;	//	Энгельс
	case	'yakutsk': $region = '124207'; break;	//	Якутск
	case	'yaroslavl': $region = '93746'; break;	//	Ярославль
 	default:
 		die("Unknown region\n");  		
}

$options 			 = array(CURLOPT_COOKIE => 'geoshop=' . $region); 	// Подставляем coockie региона
$urlStart 		 = 'https://www.enter.ru/search?q=' . ENGINE_TYPE. '&sort=default-desc';	// Первая часть адреса &page=
$urlEnd				 = '';							 																				// Вторая часть адреа и поисковая строка
$regexpP 			 = "~class=\"bSortingLine(.+)</ul>~isU";							// Пагинация
$regexpP2 		 = "~js-category-pagination-page\".*a.*>(.+)<~isU";					// Пагинация
$regexpPrices  = "~<li class=\"bListingItem js-listing-item.*>(.+)btnView~isU";
$regexpPrices2 = "~<div class=\"bListingItem__eInner\">.*<p class=\"bSimplyDesc__eText\"><a href=\"(.+)\".*>(.+)<.*class=\"bPriceLine.*class=\"bPriceLine.*<span class=\"bPrice.*\"><strong>(.+)<~isU"; // Режем карточки товара

/*
if (1 == 2) { // TASKS
	$AC->add_debug_msg('TASKS:');
	$AC->flush_requests();
	$AC->__set('callback', 'callback_two');
	while ($bad_urls) {
		if (round(microtime(1) - $time_start, 0) >= 240) break;
	  $AC->flush_requests();
	  foreach ($bad_urls as $url => $attr) {
	    $AC->get($url, NULL, $options);     
	  }
	  $bad_urls = array();
	  $AC->execute(WINDOW_SIZE);
	}
} else {
	*/
	// Узнаем, сколько позиций в пагинации
	$AC->get($urlStart.'&page=1', NULL, $options);
	$AC->get($urlStart.'&page=2', NULL, $options);
	$AC->get($urlStart.'&page=3', NULL, $options);
	$AC->get($urlStart.'&page=4', NULL, $options);
	if (ENGINE_TYPE == 'vitek' || ENGINE_TYPE == 'rondell') {
		$AC->get($urlStart.'&page=5', NULL, $options);
	}
	$AC->execute(3);	

	while ($bad_urls) {
		if (round(microtime(1) - $time_start, 0) >= 120 || $qOfPaginationPages) break;
	  $AC->flush_requests();
	  foreach ($bad_urls as $url) {
	    $AC->get($url, NULL, $options);     
	  }
	  $bad_urls = array();
	  $AC->execute(3);
	}


	if ($qOfPaginationPages > 4) {
		$AC->flush_requests();
		$AC->__set('callback','callback_two');	
		for ($i = 1; $i <= $qOfPaginationPages; $i++) {
		  $AC->get($urlStart . '&page=' . $i, NULL, $options);
		}
		$AC->execute(3);

		while ($bad_urls) {
			if (round(microtime(1) - $time_start, 0) >= 180) break;
		  $AC->flush_requests();
		  foreach ($bad_urls as $url) {
		    $AC->get($url, NULL, $options);     
		  }
		  $bad_urls = array();
		  $AC->execute(3);
		}
	}
//}



/** 
 *              Callback Functions           
 */
function callback_one($response, $info, $request) {
  global $regexpP;
  global $regexpP2;
  global $qOfPaginationPages;
  global $bad_urls;
	global $regexpPrices;
	global $regexpPrices2;
	global $itemsArray;
	global $time_start;	

	AngryCurl::add_debug_msg(PHP_EOL.$request->url);
	AngryCurl::add_debug_msg($info['http_code']);
	AngryCurl::add_debug_msg($request->options[10004]);

  if ($info['http_code'] !== 200) {            
    $bad_urls[] = $request->url;
  } else {
		preg_match($regexpP, $response, $matches);
		//print_r($matches);
		preg_match_all($regexpP2, $matches[1], $matches2);
		//print_r($matches2);
		if (max($matches2[1]) > $qOfPaginationPages) {
			$qOfPaginationPages = max($matches2[1]);		    	
		}
		//echo 'PAGES - '.$qOfPaginationPages.PHP_EOL;
  	preg_match_all($regexpPrices, $response, $matches2, PREG_SET_ORDER); //
  	foreach ($matches2 as $key) {
			preg_match($regexpPrices2, $key[1], $matches);
			$matches[1] = 'http://'.ENGINE_CURR.trim($matches[1]);
			$matches = clean_info($matches, array(1,2,3));
			if ($matches != false) {
				price_change_detect($matches[1], $matches[2], $matches[3], date("d.m.y-H:i:s"), $request->options[10004], @$request->options[10006], $request->options[10018], ENGINE_CURR, ENGINE_TYPE);
				$itemsArray[$matches[1]] = array($matches[2], $matches[3], date("d.m.y-H:i:s"), $request->options[10004]);		
				AngryCurl::add_debug_msg($matches[2].' | '.$matches[3]);
			}
		} 
		
  }
}

function callback_two($response, $info, $request) {
	global $regexpPrices;
	global $regexpPrices2;
	global $matches;
	global $itemsArray;
	global $bad_urls;
	global $time_start;

	AngryCurl::add_debug_msg(PHP_EOL.$request->url);
	AngryCurl::add_debug_msg($info['http_code']);
	AngryCurl::add_debug_msg($request->options[10004]);

  if ($info['http_code'] !== 200 || !$response) {
    $bad_urls[] = $request->url;
  } else {	
  	preg_match_all($regexpPrices, $response, $matches2, PREG_SET_ORDER); //
  	foreach ($matches2 as $key) {
			preg_match($regexpPrices2, $key[1], $matches);
			if ($matches[1]) {
				$matches[2] = str_replace(';', '', $matches[2]);
				price_change_detect('http://' . ENGINE_CURR . trim($matches[1]), trim(str_replace('&quot;', '', $matches[2])), trim($matches[3]), date("d.m.y-H:i:s"), $request->options[10004], @$request->options[10006], $request->options[10018], ENGINE_CURR, ENGINE_TYPE);
				$itemsArray['http://' . ENGINE_CURR . trim($matches[1])] = array(trim(str_replace('&quot;', '', $matches[2])), trim($matches[3]), date("d.m.y-H:i:s"), $request->options[10004]);		
				AngryCurl::add_debug_msg($matches[2].' | '.$matches[3]);
			}
		} 
    if (stripos($info['url'], ENGINE_CURR) !== false && $response && strripos($response, '</html') === false) {       
      $bad_urls[] = $request->url;  
    }			
  }
}
