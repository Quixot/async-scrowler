<?php
/**
 * technopark.ru
 */
$domain = '';
switch (EXTRA_PARAM) {
  case 'abakan': 
  	$region = '37255';
    break;  
  case 'almetevsk': 
  	$region = '38214';
    break; 
  case 'anapa': 
  	$region = '38687';
    break;
  case 'angarsk': 
  	$region = '37398';
    break; 
  case 'apatity': 
  	$region = '39026';
    break;
  case 'arzamas': 
  	$region = '39110';
    break; 
  case 'armavir': 
  	$region = '38569';
    break;
  case 'arhangelsk': 
  	$region = '37259';
  	$city = 'Архангельск';
    break; 
  case 'astrakhan': 
  	$region = '37280';
    break;
  case 'achinsk': 
  	$region = '37181';
    break; 
  case 'balakovo': 
  	$region = '37997';
    break;
  case 'barnaul': 
  	$region = '37319';
    break; 
  case 'belgorod': 
  	$region = '37348';
  	$domain = 'belgorod.';
    break;
  case 'biysk': 
  	$region = '37344';
    break; 
  case 'borisoglebsk': 
  	$region = '37873';
    break;
  case 'bratsk': 
  	$region = '37389';
    break; 
  case 'bryansk': 
  	$region = '37454';
  	$domain = 'bryansk.';
    break;
  case 'velikijnovgorod': 
  	$region = '37569';
    break; 
  case 'vladikavkaz': 
  	$region = '37645';
    break;
  case 'vladimir': 
  	$region = '37662';
  	$domain = 'vladimir.';
    break; 
  case 'volgodonsk': 
  	$region = '39630';
    break;
  case 'volzhskij': 
  	$region = '56628';
    break; 
  case 'vologda': 
  	$region = '37818';
  	$domain = 'vologda.';
    break;
  case 'gubkin': 
  	$region = '37367';
    break;
  case 'derbent': 
  	$region = '38977';
    break; 
  case 'dimitrovgrad': 
  	$region = '39376';
    break;
  case 'essentuki': 
  	$region = '56501';
    break;
  case 'zheleznogorsk': 
  	$region = '37196';
    break; 
  case 'ivanovo': 
  	$region = '37719';
    break;
  case 'izhevsk': 
  	$region = '38251';
    break;
  case 'irkutsk': 
  	$region = '37411';
    break; 
  case 'joshkar-ola': 
  	$region = '38276';
    break;
  case 'kaliningrad': 
  	$region = '38339';
    break;
  case 'kaluga': 
  	$region = '37526';
  	$domain = 'kaluga.';
    break; 
  case 'kamyshin': 
  	$region = '37771';
    break;
  case 'kasimov': 
  	$region = '39700';
    break;
  case 'kemerovo': 
  	$region = '38498';
    break; 
  case 'kirov': 
  	$region = '38291';
    break;
  case 'kislovodsk': 
  	$region = '56504';
    break;
  case 'kostroma': 
  	$region = '40107';
    break; 
  case 'krasnoturinsk': 
  	$region = '91362';
    break;
  case 'kropotkin': 
  	$region = '38615';
    break;
  case 'kurgan': 
  	$region = '38768';
    break; 
  case 'kursk': 
  	$region = '37972';
  	$domain = 'kursk.';
    break;
  case 'lipeck': 
  	$region = '38797';
    break;
  case 'lyantor': 
  	$region = '39098';
    break;
  case 'magnitogorsk': 
  	$region = '38909';
    break; 
  case 'majkop': 
  	$region = '38751';
    break;
  case 'mahachkala': 
  	$region = '38982';
    break;
  case 'miass': 
  	$region = '38944';
    break;
  case 'mineralnye-vody': 
  	$region = '56507';
    break; 
  case 'murmansk': 
  	$region = '39037';
    break;
  case 'naberezhnye-chelny': 
  	$region = '38229';
  	$city = 'Набережные Челны';
    break;
  case 'nalchik': 
  	$region = '39049';
    break;
  case 'nevinnomyssk': 
  	$region = '39599';
    break; 
  case 'neftekamsk': 
  	$region = '38861';
    break;
  case 'nefteyugansk': 
  	$region = '39100';
    break;
  case 'nizhnevartovsk': 
  	$region = '39091';
    break;
  case 'nizhnekamsk': 
  	$region = '38230';
    break; 
  case 'nizhnij-tagil': 
  	$region = '38149';
    break;
  case 'novokuzneck': 
  	$region = '38528';
    break;
  case 'novorossijsk': 
  	$region = '38706';
    break;
  case 'novotroick': 
  	$region = '39351';
    break; 
  case 'novocherkassk': 
  	$region = '39664';
    break;
  case 'novyj-urengoj': 
  	$region = '57285';
    break;
  case 'noyabrsk': 
  	$region = '57286';;
    break;
  case 'nyagan': 
  	$region = '57288';
    break; 
  case 'obninsk': 
  	$region = '37540';
  	$domain = 'obninsk.';
    break;
  case 'orel': 
  	$region = '38393';
  	$domain = 'orel.';
    break;
  case 'orenburg': 
  	$region = '39337';
    break;
  case 'pavlovo': 
  	$region = '39159';
    break; 
  case 'penza': 
  	$region = '39218';
    break;
  case 'pervouralsk': 
  	$region = '38133';
    break;
  case 'petrozavodsk': 
  	$region = '39500';
  	$city = 'Петрозаводск';
    break;
  case 'pskov': 
  	$region = '39534';
    break;
  case 'pyatigorsk': 
  	$region = '39568';
  	$city = 'Пятигорск';
    break;
  case 'revda': 
  	$region = '38136';
    break;
  case 'rybinsk': 
  	$region = '40145';
    break;
  case 'ryazan': 
  	$region = '39721';
    break;
  case 'salavat': 
  	$region = '38870';
    break;
  case 'saransk': 
  	$region = '39361';
    break;
  case 'saratov': 
  	$region = '38047';
    break;
  case 'sarov': 
  	$region = '81275';
    break;
  case 'severodvinsk': 
  	$region = '37268';
    break;
  case 'seversk': 
  	$region = '57073';
    break;
  case 'smolensk': 
  	$region = '39999';
    break;
  case 'solnechnogorsk': 
  	$region = '37129';
    break;
  case 'sochi': 
  	$region = '38733';
  	$domain = 'sochi.';
    break;
  case 'stavropol': 
  	$region = '39612';
    break;
  case 'staryj-oskol': 
  	$region = '37368';
    break;
  case 'sterlitamak': 
  	$region = '38872';
    break;
  case 'stupino': 
  	$region = '80382';
    break;
  case 'surgut': 
  	$region = '39104';
  	$domain = 'surgut.';
    break;
  case 'syzran': 
  	$region = '39786';
    break;
  case 'syktyvkar': 
  	$region = '38319';
    break;
  case 'taganrog': 
  	$region = '39678';
    break;
  case 'tambov': 
  	$region = '38095';
    break;
  case 'tver': 
  	$region = '39021';
    break;
  case 'tobolsk': 
  	$region = '57109';
    break;
  case 'tolyatti': 
  	$region = '39787';
    break;
  case 'tomsk': 
  	$region = '39087';
    break;
  case 'tuapse': 
  	$region = '38675';
    break;
  case 'tula': 
  	$region = '38474';
  	$domain = 'tula.';
    break;
  case 'tyumen': 
  	$region = '40055';
  	$domain = 'tyumen.';
    break;
  case 'ulan-udeh': 
  	$region = '40060';
    break;
  case 'ulyanovsk': 
  	$region = '39403';
    break;
  case 'uhta': 
  	$region = '56388';
    break;
  case 'habarovsk': 
  	$region = '38560';
  	$city = 'Хабаровск';
    break;
  case 'hanty-mansijsk': 
  	$region = '39107';
    break;
  case 'cheboksary': 
  	$region = '40086';
  	$city = 'Чебоксары';
    break;
  case 'cherepovec': 
  	$region = '37857';
    break;
  case 'cherkessk': 
  	$region = '40031';
    break;
  case 'chita': 
  	$region = '40089';
    break;
  case 'shahty': 
  	$region = '39682';
    break;
  case 'ehngels': 
  	$region = '38061';
    break;
  case 'yakutsk': 
  	$region = '39054';
    break;
  case 'yaroslavl': 
  	$region = '40152';
    break;

// Города-Миллионики
  case 'moscow': 
  	$region = '36966';
  	$city = 'Москва';
    break;
  case 'spb': 
  	$region = '39943';
  	$domain = 'spb.';
  	$city = 'Санкт-Петербург';
    break;
  case 'rostov': 
  	$region = '39943';
  	$domain = 'rostov-na-donu.';
  	$city = 'Ростов-на-Дону';
    break;        
  case 'novosibirsk':
  	$region = '39273';
  	$domain = 'novosibirsk.';
  	$city = 'Новосибирск';
  	break;
  case 'yekaterinburg':
  	$region = '38109';
  	$domain = 'ekaterinburg.';
  	$city = 'Екатеринбург';
  	break; 
 	case 'chelyabinsk':
 		$region = '38968';
 		$city = 'Челябинск';
 		$domain = 'chelyabinsk.';
 		break;
 	case 'volgograd':
 		$region = '37756';
 		$city = 'Волгоград';
 		$domain = 'volgograd.';
 		break; 
 	case 'perm':
 		$region = '39460';
 		break;
 	case 'kazan':
 		$region = '38178';
 		break;
 	case 'novgorod':
 		$region = '39155';
 		$city = 'Нижний Новгород';
 		$domain = 'nizhniy-novgorod.';
 		break;
 	case 'omsk':
 		$region = '39315';
 		$city = 'Омск';
 		$domain = 'omsk.';
 		break;
 	case 'samara':
 		$region = '39767';
 		$city = 'Самара';
 		$domain = 'samara.';
 		break;
 	case 'ufa':
 		$region = '38882';
 		$city = 'Уфа';
 		$domain = 'ufa.';
 		break;
 	case 'krasnoyarsk':
 		$region = '37208';
 		$city = 'Красноярск';
 		$domain = 'krasnoyarsk.';
 		break;
 	case 'krasnodar':
 		$region = '38612';
 		$city = 'Краснодар';
 		break;
 	case 'voronezh':
 		$region = '37881';
 		$city = 'Воронеж';
 		break;
 	case 'vladivostok':
 		$region = '37593';
 		$city = 'Владивосток';
 		break;
 	default:
 		die("Unknown region\n");
}

if ($domain) {
	$urlStart = 'http://'.$domain.'technopark.ru/search/?q=' . ENGINE_TYPE;//.'&count=48'
} else {
	$urlStart = 'http://www.technopark.ru/search/index.php?c=' . $region . '&q=' . ENGINE_TYPE;//.'&count=48'
}
$regexpP	= "~js-data--listing(.+)js-data--listing~isU";
$regexpP2 = "~<a.*>(.+)<~isU";
$regexpPrices = "~<article(.+)</article>~isU"; 	// Все товары на странице
$regexpPrices2 = "~href=\"(.+)\".*title=\"(.+)\".*class=\"card-listing__price\".*span.*>(.+)<~isU";
$regexpPrices3 = "~href=\"(.+)\".*title=\"(.+)\"~isU";
$regexpReg = "~js-city-.*</svg>(.+)</~isU";
$options 			 = array(
								//CURLOPT_COOKIEJAR       => '/var/www/engines/technopark.ru1/cook.txt',
        				//CURLOPT_COOKIEFILE      => '/var/www/engines/technopark.ru1/cook.txt',
        				CURLOPT_COOKIE => 'tp_city_id='.$region,
        				CURLOPT_REFERER         => 'https://www.technopark.ru',
                CURLOPT_CONNECTTIMEOUT => 20,
                CURLOPT_TIMEOUT        => 30,
                CURLOPT_AUTOREFERER     => TRUE,
                CURLOPT_FOLLOWLOCATION  => TRUE,
                CURLOPT_HEADER => true, 
                CURLOPT_SSL_VERIFYPEER => 0	
	);
//$options 			= array(CURLOPT_COOKIE => '_space=' . $region); 	// Подставляем coockie региона

	$directLinks = explode("\n", file_get_contents(AC_DIR.'/engines/'.ENGINE_CURR.'/'.ENGINE_TYPE.'.txt'));
	echo AC_DIR.'/engines/'.ENGINE_CURR.'/'.ENGINE_TYPE.'.txt'.PHP_EOL;
	array_walk($directLinks, 'trim_value');
	//print_r($directLinks);die();

	// Загрузка отсканированных ссылок:
	foreach ($itemsArray as $key => $value) {
		$date = DateTime::createFromFormat('d.m.y-H:i:s', $value[2]);
		//echo (time() - $date->format('U')).PHP_EOL; 
		if (time() - $date->format('U') <= 5400) {
			$already_scanned[] = trim($value[5]);
		}
		
	}
	if ($already_scanned) {
		$already_scanned = array_unique($already_scanned);
		$already_scanned = array_values($already_scanned);
		print_r($already_scanned); 
	} else {
		$already_scanned = array();
	}
	$already_scanned = array();
	
	$AC->flush_requests();
	$AC->__set('callback','callback_two');	

	if ($domain) {
		$is_any = 0;
		foreach ($directLinks as $nmb => $addr) {
			//$urlStart = 'http://'.$domain.'technopark.ru/search/?q=' . ENGINE_TYPE;
			$url = trim(str_replace('www.', $domain, $addr));
			if (!in_array($url, $already_scanned)) {
				echo 'сканирую адрес:'.PHP_EOL.$url.PHP_EOL;
				$AC->get($url, NULL, $options);
				$is_any = 1;
			} else {
				echo 'уже сканировал:'.PHP_EOL.$url.PHP_EOL;
			}
		}
	} else {
		$is_any = 0;
		foreach ($directLinks as $nmb => $addr) {
			$url = trim($addr).'?c='.$region;
			if (!in_array($url, $already_scanned)) {
				echo 'сканирую адрес:'.PHP_EOL.$url.PHP_EOL;
				$AC->get($url, NULL, $options);
				$is_any = 1;
			} else {
				echo 'уже сканировал:'.PHP_EOL.$url.PHP_EOL;
			}
		}
	}
	if ($is_any) {
		$AC->execute(WINDOW_SIZE);
	}
	
	while ($bad_urls) {
	  $AC->flush_requests();
	  foreach ($bad_urls as $urls) {
	    $AC->get($urls, null, $options);
	  }
	  unset($urls);
	  $bad_urls = array();    
	  $AC->execute(WINDOW_SIZE);
	}	
	unset($urls);	


	file_put_contents(AC_DIR . DIRECTORY_SEPARATOR . 'engines' . DIRECTORY_SEPARATOR . ENGINE_CURR . DIRECTORY_SEPARATOR . 'data' . DIRECTORY_SEPARATOR . date("d.m.y") . '_' . ENGINE_CURR . '_' . ENGINE_TYPE . '_' . EXTRA_PARAM . '.data', serialize($itemsArray));
	$filename = AC_DIR . DIRECTORY_SEPARATOR . 'reports' . DIRECTORY_SEPARATOR . ENGINE_CURR . '_' . ENGINE_TYPE . '_' . EXTRA_PARAM . '.csv';


/** 
 *              Callback Functions           
 */
function callback_one($response, $info, $request) {
  global $regexpP;
  global $regexpP2;  
  global $qOfPaginationPages;
  global $bad_urls;
	global $regexpPrices;
	global $regexpPrices2;
	global $regexpPrices3;
	global $itemsArray;
	global $time_start;
	global $errorsArray;
	global $regexpReg;
	global $city;

  if ($info['http_code'] !== 200) {            
    $bad_urls[] = $request->url;
    if (round(microtime(1) - $time_start, 0) >= 1800) { $bad_urls = array(); }
  } else {
  	//file_put_contents('/var/www/polaris/engines/technopark.ru/content.txt', $response);
  	preg_match($regexpReg, $response, $mReg);
  	print_r($mReg);
  	$mReg[1] = trim(strip_tags($mReg[1]));
  	AngryCurl::add_debug_msg($mReg[1].' | '.$city);	

  	if ($city == $mReg[1]) {
			preg_match($regexpP, $response, $matches);
			print_r($matches);
			preg_match_all($regexpP2, $matches[0], $matches2);
			//print_r($matches2);
			$temparrpage = array();
			foreach ($matches2[1] as $key => $value) {

				echo "value:" . $value . "\n";
				if (is_numeric($value)) {
					$temparrpage[] = $value;
				}
			}
			if (@max($temparrpage) > $qOfPaginationPages) {
				$qOfPaginationPages = @max($temparrpage);		    	
			}

	  	preg_match_all($regexpPrices, $response, $matches2, PREG_SET_ORDER); //
	  	
	  	foreach ($matches2 as $key) {
				preg_match($regexpPrices2, $key[1], $matches);
				if ($matches[1]) {
					$matches[1] = 'https://' . ENGINE_CURR . trim($matches[1]);
					$matches[2] = trim($matches[2]);

					if (stripos($matches[3], ',') !== false) {
						$matches[3] = str_replace(',', '.', $matches[3])*1000;
						//$matches[3] = preg_replace('~[^\d]+~', '', $matches[3]);
					} else {
						$matches[3] = preg_replace('~[^\d]+~', '', $matches[3]);
					}

					price_change_detect($matches[1], $matches[2], $matches[3], date("d.m.y-H:i:s"), $request->options[10004], $request->options[10006], $request->options[10018], ENGINE_CURR, ENGINE_TYPE);
					$itemsArray[$matches[1]] = array($matches[2], $matches[3],
							date("d.m.y-H:i:s"),
							$request->options[10004],
							$request->options[10018],
							$request->url);		
					AngryCurl::add_debug_msg($matches[1].' | '.$matches[2].' | '.$matches[3]);
				} else {
					preg_match($regexpPrices3, $key[1], $matches);
					if ($matches[1]) {
						$matches[1] = 'https://' . ENGINE_CURR . trim($matches[1]);
						$matches[2] = trim($matches[2]);
						$matches[3] = '0';
						price_change_detect($matches[1], $matches[2], $matches[3], date("d.m.y-H:i:s"), $request->options[10004], $request->options[10006], $request->options[10018], ENGINE_CURR, ENGINE_TYPE);
						$itemsArray[$matches[1]] = array($matches[2], $matches[3],
								date("d.m.y-H:i:s"),
								$request->options[10004],
								$request->options[10018],
								$request->url);		
						AngryCurl::add_debug_msg($matches[1].' | '.$matches[2].' | '.$matches[3]);	
					}				
				}
			}
		} else {
	    $bad_urls[] = $request->url;
			if (round(microtime(1) - $time_start, 0) >= 60) { $bad_urls = array(); } 
			AngryCurl::add_debug_msg('Регион не совпал');			
		}
  }
}

function callback_two($response, $info, $request) {
	global $regexpPrices;
	global $regexpPrices2;
	global $regexpPrices3;
	global $matches;
	global $itemsArray;
	global $bad_urls;
	global $time_start;
	global $errorsArray;
	global $regexpReg;
	global $city;

	AngryCurl::add_debug_msg(PHP_EOL.$request->url);
	AngryCurl::add_debug_msg($info['http_code']);
	AngryCurl::add_debug_msg($request->options[10004]); 

  if ($info['http_code'] !== 200) {
    $bad_urls[] = $request->url;    	
		if (round(microtime(1) - $time_start, 0) >= 1800) { $bad_urls = array(); }    
  } else {
  	preg_match($regexpReg, $response, $mReg);
  	//print_r($mReg);
  	$mReg[1] = trim(strip_tags($mReg[1]));
  	//echo $mReg[1].PHP_EOL;

  	AngryCurl::add_debug_msg($mReg[1].' | '.$city);	

  	if (stripos($mReg[1], $city) !== false) {
	  	preg_match_all($regexpPrices, $response, $matches2, PREG_SET_ORDER); //
	  	foreach ($matches2 as $key) {
				preg_match($regexpPrices2, $key[1], $matches);
				//print_r($matches);
				if (@$matches[1]) {
					$matches[1] = 'https://' . ENGINE_CURR . trim($matches[1]);
					$matches[2] = trim($matches[2]);

					if (stripos($matches[3], ',') !== false) {
						$matches[3] = str_replace(',', '.', $matches[3])*1000;
						//$matches[3] = preg_replace('~[^\d]+~', '', $matches[3]);
					} else {
						$matches[3] = preg_replace('~[^\d]+~', '', $matches[3]);
					}

					
					price_change_detect($matches[1], $matches[2], $matches[3], date("d.m.y-H:i:s"), $request->options[10004], $request->options[10006], $request->options[10018], ENGINE_CURR, ENGINE_TYPE);
					$itemsArray[$matches[1]] = array($matches[2], $matches[3],
							date("d.m.y-H:i:s"),
							$request->options[10004],
							$request->options[10018],
							$request->url);		
					AngryCurl::add_debug_msg($matches[1].' | '.$matches[2].' | '.$matches[3]);
				} else {
					preg_match($regexpPrices3, $key[1], $matches);
					if ($matches[1]) {
						$matches[1] = 'https://' . ENGINE_CURR . trim($matches[1]);
						$matches[2] = trim($matches[2]);
						$matches[3] = '0';
						price_change_detect($matches[1], $matches[2], $matches[3], date("d.m.y-H:i:s"), $request->options[10004], $request->options[10006], $request->options[10018], ENGINE_CURR, ENGINE_TYPE);
						$itemsArray[$matches[1]] = array($matches[2], $matches[3],
								date("d.m.y-H:i:s"),
								$request->options[10004],
								$request->options[10018],
								$request->url);		
						AngryCurl::add_debug_msg($matches[1].' | '.$matches[2].' | '.$matches[3]);			
					}		
				}
			}
		} else {
	    $bad_urls[] = $request->url;
			if (round(microtime(1) - $time_start, 0) >= 60) { $bad_urls = array(); } 
			AngryCurl::add_debug_msg('Регион не совпал');			
		}		 	
  }
}
